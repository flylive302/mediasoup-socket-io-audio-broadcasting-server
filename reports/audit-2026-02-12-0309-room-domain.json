{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "meta": {
    "timestamp": "2026-02-12T03:09:00+05:00",
    "commit": "c8804ba",
    "branch": "work",
    "nodeVersion": "v24.12.0",
    "scope": "room"
  },
  "scores": {
    "performance": 7,
    "architecture": 8,
    "realtime": 6,
    "codeQuality": 6,
    "security": 8,
    "readability": 8,
    "total": 71
  },
  "findings": [
    {
      "id": "ROOM-DC-001",
      "severity": "HIGH",
      "dimension": "Code Quality",
      "file": "src/domains/room/room.handler.ts",
      "function": "room:join handler",
      "problem": "clientsByUserId Map is allocated and populated on every join but never read",
      "evidence": "const clientsByUserId = new Map<string, â€¦>() + clientsByUserId.set(String(c.userId), c)",
      "impact": "Wasted allocation + O(N) set operations on every room join",
      "fix": "Remove L47 and L67 entirely",
      "complexity": "0.1h"
    },
    {
      "id": "ROOM-BL-001",
      "severity": "HIGH",
      "dimension": "Realtime Correctness",
      "file": "src/domains/room/room.handler.ts + auto-close/auto-close.service.ts",
      "function": "recordActivity",
      "problem": "recordActivity only called on join, not on leave/chat/gifts/seats as docstring claims",
      "evidence": "grep for recordActivity shows exactly 1 call site (room.handler.ts:134)",
      "impact": "Rooms with sustained activity but no new joins will be falsely auto-closed after 30s",
      "fix": "Call autoCloseService.recordActivity(roomId) in chat, gift, seat handlers, and room:leave",
      "complexity": "1h"
    },
    {
      "id": "ROOM-BL-002",
      "severity": "HIGH",
      "dimension": "Realtime Correctness",
      "file": "src/domains/room/room.handler.ts",
      "function": "room:leave handler",
      "problem": "room:leave does NOT call clientManager.removeClient() or clear the roomClients index",
      "evidence": "Compare room:leave (L183-223) vs handleDisconnect (socket/index.ts:220)",
      "impact": "Stale entries in roomClients index; getClientsInRoom returns ghost clients",
      "fix": "Clear client.roomId from the room index after socket.leave()",
      "complexity": "0.5h"
    },
    {
      "id": "ROOM-DC-002",
      "severity": "MEDIUM",
      "dimension": "Code Quality",
      "file": "src/domains/room/types.ts + roomManager.ts",
      "function": "RoomState.speakers",
      "problem": "speakers[] field initialized to [] and never updated anywhere",
      "evidence": "grep for speakers in room/ shows only declaration and initialization",
      "impact": "Dead field serialized to Redis on every state save",
      "fix": "Remove speakers from RoomState interface and doCreateRoom",
      "complexity": "0.2h"
    },
    {
      "id": "ROOM-DC-003",
      "severity": "MEDIUM",
      "dimension": "Code Quality",
      "file": "src/domains/room/types.ts",
      "function": "Seat interface",
      "problem": "Seat interface defined but never imported by any file",
      "evidence": "grep for import from room/types returns 0 matches for Seat",
      "impact": "Dead code",
      "fix": "Remove Seat interface",
      "complexity": "0.1h"
    },
    {
      "id": "ROOM-DC-004",
      "severity": "MEDIUM",
      "dimension": "Code Quality",
      "file": "src/domains/room/types.ts",
      "function": "RoomStatus type",
      "problem": "Only ACTIVE is ever used; CREATED, CLOSING, CLOSED are dead values",
      "evidence": "grep for CREATED/CLOSING/CLOSED shows zero usage beyond type definition",
      "impact": "Misleading type suggests state machine that doesn't exist",
      "fix": "Reduce to ACTIVE only or implement state machine",
      "complexity": "0.2h"
    },
    {
      "id": "ROOM-DC-005",
      "severity": "MEDIUM",
      "dimension": "Code Quality",
      "file": "src/domains/room/roomState.ts",
      "function": "RoomStateRepository.get",
      "problem": "get() method defined but never called",
      "evidence": "grep for stateRepo.get and state.get( returns 0 results",
      "impact": "Dead code",
      "fix": "Remove or mark @internal",
      "complexity": "0.1h"
    },
    {
      "id": "ROOM-DC-006",
      "severity": "LOW",
      "dimension": "Code Quality",
      "file": "src/domains/room/index.ts",
      "function": "barrel export",
      "problem": "RoomStateRepository exported but never imported externally",
      "evidence": "Only imported via relative import in roomManager.ts",
      "impact": "Pollutes public API surface",
      "fix": "Remove export from barrel",
      "complexity": "0.1h"
    },
    {
      "id": "ROOM-PERF-001",
      "severity": "MEDIUM",
      "dimension": "Performance & Efficiency",
      "file": "src/domains/room/roomState.ts",
      "function": "adjustParticipantCount",
      "problem": "Lua script string created inline on every call; redis.eval() recompiles it",
      "evidence": "const luaScript = `...` inside method body, called via redis.eval()",
      "impact": "Redis SHA1-hashes and parses Lua on every participant join/leave",
      "fix": "Use redis.defineCommand() or SCRIPT LOAD + EVALSHA",
      "complexity": "0.5h"
    },
    {
      "id": "ROOM-PERF-002",
      "severity": "LOW",
      "dimension": "Performance & Efficiency",
      "file": "src/domains/room/roomManager.ts",
      "function": "getRoom",
      "problem": "getRoom() is async but only does synchronous Map.get()",
      "evidence": "async getRoom(roomId: string): Promise<RoomMediaCluster | undefined> { return this.rooms.get(roomId); }",
      "impact": "Unnecessary Promise allocation on every media event",
      "fix": "Remove async, return synchronously. Update callers",
      "complexity": "0.5h"
    },
    {
      "id": "ROOM-BL-003",
      "severity": "MEDIUM",
      "dimension": "Architecture & Scalability",
      "file": "src/domains/room/room.handler.ts + roomManager.ts",
      "function": "room:join + doCreateRoom",
      "problem": "seatCount from join payload never persisted to room state (hardcoded to 15)",
      "evidence": "BL-008 comment says 'updated when first joiner sends seatCount' but no update code exists",
      "impact": "Room state in Redis always shows seatCount=15 regardless of actual config",
      "fix": "Check if state.seatCount differs and update via stateRepo",
      "complexity": "0.5h"
    },
    {
      "id": "ROOM-BL-004",
      "severity": "MEDIUM",
      "dimension": "Realtime Correctness",
      "file": "src/domains/room/room.handler.ts",
      "function": "room:leave handler",
      "problem": "room:leave does not call recordActivity",
      "evidence": "No autoCloseService.recordActivity call in room:leave handler",
      "impact": "Room may be auto-closed immediately after last user leaves if activity key expired",
      "fix": "Add autoCloseService.recordActivity(roomId) to room:leave Promise.all",
      "complexity": "0.2h"
    },
    {
      "id": "ROOM-ARCH-001",
      "severity": "MEDIUM",
      "dimension": "Performance & Efficiency",
      "file": "src/domains/room/roomManager.ts",
      "function": "closeRoom",
      "problem": "cluster.close(), stateRepo.delete(), seatRepository.clearRoom() are serialized but independent",
      "evidence": "L181-190: sequential awaits for independent operations",
      "impact": "Close time = sum instead of max of all operations",
      "fix": "Parallelize with Promise.all",
      "complexity": "0.3h"
    },
    {
      "id": "ROOM-INFO-001",
      "severity": "INFO",
      "dimension": "Code Quality",
      "file": "tests/unit/domains/room/* (missing)",
      "function": "N/A",
      "problem": "Zero test coverage for entire room domain",
      "evidence": "find tests/ shows 0 room test files",
      "impact": "High regression risk",
      "fix": "Add unit tests",
      "complexity": "4h"
    },
    {
      "id": "ROOM-INFO-002",
      "severity": "INFO",
      "dimension": "Code Quality",
      "file": "src/socket/schemas.ts",
      "function": "joinRoomSchema",
      "problem": "joinRoomSchema uses z.string() instead of roomIdSchema (z.string().min(1))",
      "evidence": "L161: roomId: z.string() vs L167: roomId: roomIdSchema",
      "impact": "Accepts empty string roomIds on join; inconsistent with other schemas",
      "fix": "Replace z.string() with roomIdSchema",
      "complexity": "0.1h"
    }
  ],
  "overEngineering": []
}
