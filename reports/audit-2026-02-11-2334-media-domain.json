{
  "meta": {
    "timestamp": "2026-02-11T23:34:00+05:00",
    "commit": "a6d5087",
    "branch": "work",
    "nodeVersion": "v24.12.0",
    "domain": "media",
    "files": [
      "src/domains/media/media.handler.ts",
      "src/domains/media/routerManager.ts",
      "src/domains/media/activeSpeaker.ts",
      "src/domains/media/roomMediaCluster.ts",
      "src/domains/media/index.ts"
    ]
  },
  "scores": {
    "performance": 27,
    "architecture": 17,
    "realtime": 14,
    "codeQuality": 13,
    "security": 8,
    "readability": 8,
    "total": 87
  },
  "findings": [
    {
      "id": "PERF-MED-001",
      "severity": "MEDIUM",
      "dimension": "Performance & Efficiency",
      "file": "src/domains/media/roomMediaCluster.ts",
      "function": "getConsumer()",
      "problem": "Linear scan across all distribution routers for every consumer lookup",
      "evidence": "for (const dist of this.distributionRouters) { const c = dist.routerManager.getConsumer(consumerId); if (c) return c; }",
      "impact": "O(D×C) lookup on every consumer:resume with 10+ dist routers",
      "fix": "Add cluster-level Map<consumerId, DistributionRouter> for O(1) lookup",
      "complexity": "0.5 hours"
    },
    {
      "id": "PERF-LOW-001",
      "severity": "LOW",
      "dimension": "Performance & Efficiency",
      "file": "src/domains/media/roomMediaCluster.ts",
      "function": "findDistributionRouterForTransport()",
      "problem": "Duplicate lookup when transportOwnership map already exists",
      "evidence": "Linear scan through distributionRouters array",
      "impact": "Minor O(D) instead of O(1) during consume()",
      "fix": "Change transportOwnership to map transportId → DistributionRouter",
      "complexity": "0.5 hours"
    },
    {
      "id": "ARCH-MED-001",
      "severity": "MEDIUM",
      "dimension": "Architecture & Scalability",
      "file": "src/domains/media/roomMediaCluster.ts",
      "function": "registerConsumer()",
      "problem": "Registers on first distribution router only, ignoring transport ownership",
      "evidence": "for (const dist of this.distributionRouters) { dist.routerManager.registerConsumer(consumer); return; }",
      "impact": "Misleading API — unused in practice but confusing",
      "fix": "Remove this method or accept transportId parameter",
      "complexity": "0.25 hours"
    },
    {
      "id": "ARCH-LOW-001",
      "severity": "LOW",
      "dimension": "Architecture & Scalability",
      "file": "src/domains/media/routerManager.ts",
      "function": "RouterManager.setActiveSpeakerDetector()",
      "problem": "Dead code — activeSpeakerDetector is only used on RoomMediaCluster",
      "evidence": "Both RouterManager and RoomMediaCluster store activeSpeakerDetector",
      "impact": "Confusing dual ownership",
      "fix": "Remove activeSpeakerDetector from RouterManager",
      "complexity": "0.25 hours"
    },
    {
      "id": "RT-MED-001",
      "severity": "MEDIUM",
      "dimension": "Realtime Correctness",
      "file": "src/domains/media/media.handler.ts",
      "function": "audioProduceHandler",
      "problem": "No authorization check that socket user is a seated speaker before producing",
      "evidence": "const producer = await transport.produce({ kind, rtpParameters, appData: { userId: socket.data.user.id } });",
      "impact": "Any authenticated user could produce audio without being seated",
      "fix": "Verify user has a seat or document that enforcement is upstream",
      "complexity": "0.5 hours"
    },
    {
      "id": "RT-LOW-001",
      "severity": "LOW",
      "dimension": "Realtime Correctness",
      "file": "src/domains/media/media.handler.ts",
      "function": "selfMuteHandler",
      "problem": "No verification that requesting socket owns the producerId",
      "evidence": "const producer = cluster?.getProducer(producerId);",
      "impact": "Any user with valid producerId could mute another's producer",
      "fix": "Verify producer.appData.userId === socket.data.user.id",
      "complexity": "0.25 hours"
    },
    {
      "id": "CQ-MED-001",
      "severity": "MEDIUM",
      "dimension": "Code Quality",
      "file": "src/domains/media/",
      "function": "Multiple",
      "problem": "No unit tests for media.handler.ts, routerManager.ts, or activeSpeaker.ts",
      "evidence": "Only roomMediaCluster.test.ts exists (7 tests)",
      "impact": "Regression risk on critical media infrastructure",
      "fix": "Add test files, priority: activeSpeaker.ts then routerManager.ts",
      "complexity": "3 hours"
    },
    {
      "id": "SEC-MED-001",
      "severity": "MEDIUM",
      "dimension": "Security & Reliability",
      "file": "src/domains/media/media.handler.ts",
      "function": "transportCreateHandler",
      "problem": "No limit on number of transports per client",
      "evidence": "Any authenticated socket can call transport:create repeatedly",
      "impact": "Resource exhaustion via transport flooding",
      "fix": "Add per-client transport limit (max 2: producer + consumer)",
      "complexity": "0.25 hours"
    },
    {
      "id": "CQ-LOW-001",
      "severity": "LOW",
      "dimension": "Code Quality",
      "file": "src/domains/media/media.handler.ts",
      "function": "audioProduceHandler",
      "problem": "Producer double-close risk in transportclose handler",
      "evidence": "producer.on('transportclose', () => { ... producer.close(); });",
      "impact": "Silently handled by mediasoup but unnecessary",
      "fix": "Add if (!producer.closed) guard before close()",
      "complexity": "0.1 hours"
    },
    {
      "id": "READ-INFO-001",
      "severity": "INFO",
      "dimension": "Readability",
      "file": "src/domains/media/index.ts",
      "function": "Barrel export",
      "problem": "RoomMediaCluster not exported from barrel",
      "evidence": "Only exports: mediaHandler, RouterManager, ActiveSpeakerDetector",
      "impact": "Consumers must import directly from roomMediaCluster.ts",
      "fix": "Add RoomMediaCluster to barrel export",
      "complexity": "0.1 hours"
    }
  ],
  "overEngineering": [
    {
      "file": "src/domains/media/routerManager.ts",
      "antiPattern": "Duplicate activeSpeakerDetector tracking (dead code)",
      "runtimeCost": "None (8 bytes per instance)",
      "devHoursPerYear": 1,
      "scoreDeduction": 0
    }
  ],
  "bootstrap": {
    "lint": "clean",
    "typecheck": "clean",
    "tests": "66/66 passed",
    "build": "138.86 KB ESM",
    "todos": "none in media domain",
    "consoleLogs": "none in media domain",
    "typeErosion": "none in media domain"
  }
}
