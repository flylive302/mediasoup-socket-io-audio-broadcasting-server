{
  "meta": {
    "timestamp": "2026-02-12T03:16:00+05:00",
    "auditRef": "reports/audit-2026-02-12-0309-room-domain.json",
    "commit": "c8804ba"
  },
  "remediations": [
    {
      "issueId": "ROOM-DC-001",
      "severity": "HIGH",
      "filesTouched": ["src/domains/room/room.handler.ts"],
      "patchSketch": "Remove L47 (clientsByUserId declaration) and L67 (clientsByUserId.set call)",
      "downstreamCallsites": [],
      "runtimeRisk": "Zero — pure dead code removal",
      "rollback": "git revert <commit>",
      "hours": 0.1,
      "owner": "AI",
      "priority": "P0",
      "docsUpdates": [],
      "testsRequired": []
    },
    {
      "issueId": "ROOM-BL-002",
      "severity": "HIGH",
      "filesTouched": [
        "src/domains/room/room.handler.ts",
        "src/client/clientManager.ts"
      ],
      "patchSketch": "Add clearClientRoom() method to ClientManager; call it in room:leave after socket.leave()",
      "downstreamCallsites": ["src/socket/index.ts:220 — handleDisconnect"],
      "runtimeRisk": "Low — clears local Map entry only",
      "rollback": "git revert <commit>",
      "hours": 0.5,
      "owner": "AI",
      "priority": "P0",
      "docsUpdates": [],
      "testsRequired": ["tests/unit/client/clientManager.test.ts — add clearClientRoom test"]
    },
    {
      "issueId": "ROOM-BL-004",
      "severity": "MEDIUM",
      "filesTouched": ["src/domains/room/room.handler.ts"],
      "patchSketch": "Add autoCloseService.recordActivity(roomId) to room:leave Promise.all",
      "downstreamCallsites": ["src/domains/room/auto-close/auto-close.service.ts:19"],
      "runtimeRisk": "Low — one additional Redis SET",
      "rollback": "git revert <commit>",
      "hours": 0.2,
      "owner": "AI",
      "priority": "P1",
      "docsUpdates": [],
      "testsRequired": []
    },
    {
      "issueId": "ROOM-INFO-002",
      "severity": "INFO",
      "filesTouched": ["src/socket/schemas.ts"],
      "patchSketch": "Replace z.string() with roomIdSchema in joinRoomSchema",
      "downstreamCallsites": ["src/domains/room/room.handler.ts:21"],
      "runtimeRisk": "Breaks if someone passes empty roomId",
      "rollback": "git revert <commit>",
      "hours": 0.1,
      "owner": "AI",
      "priority": "P2",
      "docsUpdates": [],
      "testsRequired": ["tests/unit/socket/schemas.test.ts — verify joinRoomSchema rejects empty"]
    },
    {
      "issueId": "ROOM-PERF-001",
      "severity": "MEDIUM",
      "filesTouched": ["src/domains/room/roomState.ts"],
      "patchSketch": "Use redis.defineCommand() for Lua script caching; replace eval() with custom command",
      "downstreamCallsites": [
        "src/domains/room/room.handler.ts:133",
        "src/domains/room/room.handler.ts:205",
        "src/socket/index.ts:193"
      ],
      "runtimeRisk": "Low — ioredis defineCommand auto-falls back to EVAL",
      "rollback": "git revert <commit>",
      "hours": 0.5,
      "owner": "AI",
      "priority": "P1",
      "docsUpdates": [],
      "testsRequired": []
    },
    {
      "issueId": "ROOM-PERF-002",
      "severity": "LOW",
      "filesTouched": [
        "src/domains/room/roomManager.ts",
        "src/domains/media/media.handler.ts",
        "src/socket/index.ts",
        "src/domains/seat/handlers/mute-seat.handler.ts",
        "src/domains/seat/handlers/unmute-seat.handler.ts",
        "src/domains/seat/handlers/lock-seat.handler.ts"
      ],
      "patchSketch": "Remove async from getRoom(), remove await from all 11 callsites",
      "downstreamCallsites": [
        "src/domains/media/media.handler.ts:36,66,86,149,189,221,256",
        "src/socket/index.ts:174",
        "src/domains/seat/handlers/mute-seat.handler.ts:58",
        "src/domains/seat/handlers/unmute-seat.handler.ts:58",
        "src/domains/seat/handlers/lock-seat.handler.ts:50"
      ],
      "runtimeRisk": "None — synchronous Map.get()",
      "rollback": "git revert <commit>",
      "hours": 0.5,
      "owner": "AI",
      "priority": "P2",
      "docsUpdates": [],
      "testsRequired": []
    },
    {
      "issueId": "ROOM-ARCH-001",
      "severity": "MEDIUM",
      "filesTouched": ["src/domains/room/roomManager.ts"],
      "patchSketch": "Replace sequential awaits with Promise.all([cluster.close(), stateRepo.delete(), seatRepo.clearRoom()])",
      "downstreamCallsites": [
        "src/socket/index.ts:58",
        "src/domains/room/roomManager.ts:136"
      ],
      "runtimeRisk": "Low — operations are independent",
      "rollback": "git revert <commit>",
      "hours": 0.3,
      "owner": "AI",
      "priority": "P1",
      "docsUpdates": [],
      "testsRequired": []
    },
    {
      "issueId": "ROOM-DC-002",
      "severity": "MEDIUM",
      "filesTouched": [
        "src/domains/room/types.ts",
        "src/domains/room/roomManager.ts"
      ],
      "patchSketch": "Remove speakers field from RoomState interface and doCreateRoom",
      "downstreamCallsites": [],
      "runtimeRisk": "Zero",
      "rollback": "git revert <commit>",
      "hours": 0.2,
      "owner": "AI",
      "priority": "P2",
      "docsUpdates": [],
      "testsRequired": []
    },
    {
      "issueId": "ROOM-DC-003",
      "severity": "MEDIUM",
      "filesTouched": ["src/domains/room/types.ts"],
      "patchSketch": "Remove Seat interface",
      "downstreamCallsites": [],
      "runtimeRisk": "Zero",
      "rollback": "git revert <commit>",
      "hours": 0.1,
      "owner": "AI",
      "priority": "P2",
      "docsUpdates": [],
      "testsRequired": []
    },
    {
      "issueId": "ROOM-DC-004",
      "severity": "MEDIUM",
      "filesTouched": ["src/domains/room/types.ts"],
      "patchSketch": "Reduce RoomStatus to just 'ACTIVE'",
      "downstreamCallsites": ["src/domains/room/roomManager.ts:94"],
      "runtimeRisk": "Zero",
      "rollback": "git revert <commit>",
      "hours": 0.2,
      "owner": "AI",
      "priority": "P2",
      "docsUpdates": [],
      "testsRequired": []
    },
    {
      "issueId": "ROOM-DC-005",
      "severity": "MEDIUM",
      "filesTouched": [],
      "patchSketch": "RESOLVED — get() method retained for use by ROOM-BL-003 seatCount persistence",
      "downstreamCallsites": [],
      "runtimeRisk": "N/A",
      "rollback": "N/A",
      "hours": 0,
      "owner": "AI",
      "priority": "P3",
      "docsUpdates": [],
      "testsRequired": []
    },
    {
      "issueId": "ROOM-DC-006",
      "severity": "LOW",
      "filesTouched": ["src/domains/room/index.ts"],
      "patchSketch": "Remove 'export { RoomStateRepository }' from barrel",
      "downstreamCallsites": [],
      "runtimeRisk": "Zero",
      "rollback": "git revert <commit>",
      "hours": 0.1,
      "owner": "AI",
      "priority": "P3",
      "docsUpdates": [],
      "testsRequired": []
    },
    {
      "issueId": "ROOM-BL-003",
      "severity": "MEDIUM",
      "filesTouched": ["src/domains/room/room.handler.ts"],
      "patchSketch": "After getOrCreateRoom(), read state and update seatCount if different from payload",
      "downstreamCallsites": ["src/domains/room/roomState.ts:10,15"],
      "runtimeRisk": "Low — one Redis GET+SET on first non-default join",
      "rollback": "git revert <commit>",
      "hours": 0.5,
      "owner": "AI",
      "priority": "P1",
      "docsUpdates": [],
      "testsRequired": []
    },
    {
      "issueId": "ROOM-BL-001",
      "severity": "HIGH",
      "filesTouched": [
        "src/domains/chat/chat.handler.ts",
        "src/domains/gift/giftHandler.ts",
        "src/domains/seat/handlers/take-seat.handler.ts",
        "src/domains/seat/handlers/leave-seat.handler.ts"
      ],
      "patchSketch": "Add fire-and-forget context.autoCloseService.recordActivity(roomId) after successful action in each handler",
      "downstreamCallsites": ["src/domains/room/auto-close/auto-close.service.ts:19"],
      "runtimeRisk": "Low — fire-and-forget Redis SET with .catch()",
      "rollback": "git revert <commit>",
      "hours": 1,
      "owner": "AI",
      "priority": "P0",
      "docsUpdates": [],
      "testsRequired": []
    },
    {
      "issueId": "ROOM-INFO-001",
      "severity": "INFO",
      "filesTouched": [],
      "patchSketch": "Future work — add unit tests for room domain",
      "downstreamCallsites": [],
      "runtimeRisk": "N/A",
      "rollback": "N/A",
      "hours": 4,
      "owner": "AI",
      "priority": "P3",
      "docsUpdates": [],
      "testsRequired": ["tests/unit/domains/room/*.test.ts — full room lifecycle coverage"]
    }
  ],
  "prPlan": [
    {
      "prNumber": 1,
      "title": "fix(room): critical BL fixes + dead alloc removal",
      "issues": ["ROOM-DC-001", "ROOM-BL-002", "ROOM-BL-004", "ROOM-INFO-002"],
      "files": [
        "src/domains/room/room.handler.ts",
        "src/client/clientManager.ts",
        "src/socket/schemas.ts"
      ],
      "dependsOn": []
    },
    {
      "prNumber": 2,
      "title": "perf(room): Lua caching, sync getRoom, parallel close",
      "issues": ["ROOM-PERF-001", "ROOM-PERF-002", "ROOM-ARCH-001"],
      "files": [
        "src/domains/room/roomState.ts",
        "src/domains/room/roomManager.ts",
        "src/domains/media/media.handler.ts",
        "src/socket/index.ts",
        "src/domains/seat/handlers/mute-seat.handler.ts",
        "src/domains/seat/handlers/unmute-seat.handler.ts",
        "src/domains/seat/handlers/lock-seat.handler.ts"
      ],
      "dependsOn": []
    },
    {
      "prNumber": 3,
      "title": "refactor(room): dead code cleanup + seatCount persist",
      "issues": ["ROOM-DC-002", "ROOM-DC-003", "ROOM-DC-004", "ROOM-DC-006", "ROOM-BL-003"],
      "files": [
        "src/domains/room/types.ts",
        "src/domains/room/roomManager.ts",
        "src/domains/room/index.ts",
        "src/domains/room/room.handler.ts"
      ],
      "dependsOn": []
    },
    {
      "prNumber": 4,
      "title": "fix(room): add recordActivity to all domain handlers",
      "issues": ["ROOM-BL-001"],
      "files": [
        "src/domains/chat/chat.handler.ts",
        "src/domains/gift/giftHandler.ts",
        "src/domains/seat/handlers/take-seat.handler.ts",
        "src/domains/seat/handlers/leave-seat.handler.ts"
      ],
      "dependsOn": []
    }
  ],
  "sprintPlan": [
    {
      "sprint": 1,
      "focus": "All fixes (single-session remediation)",
      "prs": [1, 2, 3, 4],
      "hours": 8.5
    }
  ]
}
