{
  "meta": {
    "timestamp": "2026-02-12T01:00:00Z",
    "commit": "47ea8cc7614d686af55ad1d51ea4cba29d20e99f",
    "branch": "work",
    "nodeVersion": "v24.12.0"
  },
  "scores": {
    "performance": 83,
    "architecture": 90,
    "realtime": 85,
    "codeQuality": 92,
    "security": 88,
    "readability": 92,
    "total": 87
  },
  "findings": [
    {
      "id": "PERF-010",
      "severity": "HIGH",
      "dimension": "Performance",
      "file": "src/domains/seat/seat.repository.ts",
      "function": "SeatRepository.findInviteByUser",
      "problem": "findInviteByUser uses SCAN loop with serial GETs per key, creating O(N) Redis round-trips",
      "evidence": "for (const key of keys) { const data = await this.redis.get(key); }",
      "impact": "20+ Redis round-trips instead of 1 for rooms with many pending invites",
      "repro": "Create 20 seat invites in a room, then accept one — observe N sequential Redis GETs",
      "fix": "Use MGET on each SCAN page, or maintain a reverse index room:{roomId}:invite:user:{userId} → seatIndex",
      "complexity": "Low",
      "docsPath": "https://redis.io/commands/mget/"
    },
    {
      "id": "PERF-011",
      "severity": "MEDIUM",
      "dimension": "Performance",
      "file": "src/domains/room/auto-close/auto-close.service.ts",
      "function": "AutoCloseService.getInactiveRoomIds",
      "problem": "Fires N×2 parallel Redis calls (EXISTS + GET) after SCAN, causing connection pool pressure",
      "evidence": "Promise.all(roomIds.map(async (roomId) => Promise.all([this.hasActivity(roomId), this.getParticipantCount(roomId)])))",
      "impact": "1000 concurrent Redis calls with 500 rooms, potential pipeline stall",
      "repro": "Run auto-close poll with 500+ rooms in Redis and monitor Redis connection count",
      "fix": "Use redis.pipeline() to batch all EXISTS + GET calls into a single round-trip",
      "complexity": "Low",
      "docsPath": "https://redis.io/docs/latest/develop/reference/pipelining/"
    },
    {
      "id": "PERF-012",
      "severity": "LOW",
      "dimension": "Performance",
      "file": "src/domains/gift/giftHandler.ts",
      "function": "GiftHandler.handle",
      "problem": "Transaction ID uses Math.random() which is non-cryptographic with ~60M possible values",
      "evidence": "transaction_id: `g_${Date.now()}_${socket.id}_${Math.random().toString(36).substr(2, 5)}`",
      "impact": "Low collision probability but not guaranteed unique under high volume",
      "repro": "Send 2 gifts from same socket in same millisecond",
      "fix": "Use crypto.randomUUID() (already imported in chat.handler.ts)",
      "complexity": "Trivial",
      "docsPath": "https://nodejs.org/api/crypto.html#cryptorandomuuidoptions"
    },
    {
      "id": "PERF-013",
      "severity": "LOW",
      "dimension": "Performance",
      "file": "src/domains/seat/seat.repository.ts",
      "function": "Multiple (takeSeat, leaveSeat, assignSeat)",
      "problem": "Lua scripts sent as full text via redis.eval() instead of EVALSHA, wasting bandwidth",
      "evidence": "this.redis.eval(TAKE_SEAT_LUA, 2, ...) — sends ~500 bytes per call instead of 40-byte SHA",
      "impact": "Marginal bandwidth waste, Redis caches by SHA anyway",
      "repro": "Monitor Redis network traffic during seat operations",
      "fix": "Use redis.defineCommand() or EVALSHA with pre-loaded SHA",
      "complexity": "Low",
      "docsPath": "https://redis.io/commands/evalsha/"
    },
    {
      "id": "ARCH-010",
      "severity": "MEDIUM",
      "dimension": "Architecture",
      "file": "src/domains/gift/giftHandler.ts",
      "function": "GiftHandler",
      "problem": "Uses class-based handler with inline validation, bypassing createHandler pattern",
      "evidence": "socket.on('gift:send', async (rawPayload) => { /* manual Zod parse, socket.emit('error') */ })",
      "impact": "No correlation IDs, inconsistent error format, no callback/ack support for gift events",
      "repro": "Send invalid gift payload and compare error response to seat:take error response",
      "fix": "Refactor to use createHandler for gift:send and gift:prepare events",
      "complexity": "Medium",
      "docsPath": "src/shared/handler.utils.ts"
    },
    {
      "id": "ARCH-011",
      "severity": "LOW",
      "dimension": "Architecture",
      "file": "src/domains/chat/chat.handler.ts",
      "function": "chatHandler",
      "problem": "Bypasses createHandler pattern, uses inline validation with socket.emit('error')",
      "evidence": "socket.on('chat:message', async (rawPayload) => { ... socket.emit('error', ...) })",
      "impact": "Inconsistent error response pattern across domains",
      "repro": "Send invalid chat payload and compare error format to seat handler errors",
      "fix": "Migrate to createHandler pattern",
      "complexity": "Low",
      "docsPath": "src/shared/handler.utils.ts"
    },
    {
      "id": "ARCH-012",
      "severity": "INFO",
      "dimension": "Architecture",
      "file": "src/domains/index.ts",
      "function": "domains array",
      "problem": "GiftHandler registered separately in socket/index.ts due to lifecycle methods, not in domain registry",
      "evidence": "domains array contains 5 handlers but GiftHandler is instantiated separately",
      "impact": "Minor navigation overhead for new developers",
      "repro": "Search for gift event registration — must look in socket/index.ts, not domains/index.ts",
      "fix": "Document intentional asymmetry or create DomainWithLifecycle interface",
      "complexity": "Trivial",
      "docsPath": ""
    },
    {
      "id": "RT-010",
      "severity": "HIGH",
      "dimension": "Real-time Correctness",
      "file": "src/integrations/laravelClient.ts",
      "function": "LaravelClient.canManageRoom",
      "problem": "Two sequential HTTP calls for admin authorization (getRoomData + getMemberRole)",
      "evidence": "const roomData = await this.getRoomData(roomId); ... const role = await this.getMemberRole(roomId, userId);",
      "impact": "P99 latency for admin seat actions is double that of owner actions (100ms+ with 50ms Laravel)",
      "repro": "Trigger seat:assign as an admin user and measure total handler time",
      "fix": "Use fetchRoomOwner() cache from seat.owner.ts, or combine API endpoints, or cache admin roles",
      "complexity": "Low",
      "docsPath": ""
    },
    {
      "id": "RT-011",
      "severity": "LOW",
      "dimension": "Real-time Correctness",
      "file": "src/domains/seat/seat.owner.ts",
      "function": "setRoomOwner",
      "problem": "Comment says '5 minutes' but uses magic number OWNER_CACHE_TTL_MS * 10",
      "evidence": "expiresAt: Date.now() + OWNER_CACHE_TTL_MS * 10, // 5 minutes for manually set owners",
      "impact": "Readability risk — changing base TTL changes bootstrap TTL by 10x",
      "repro": "N/A",
      "fix": "Extract OWNER_BOOTSTRAP_TTL_MS = 300_000 as named constant",
      "complexity": "Trivial",
      "docsPath": ""
    },
    {
      "id": "RT-012",
      "severity": "MEDIUM",
      "dimension": "Real-time Correctness",
      "file": "src/integrations/laravel/event-subscriber.ts",
      "function": "LaravelEventSubscriber.start",
      "problem": "No backpressure mechanism for Laravel events — fire-and-forget dispatch",
      "evidence": "this.onEvent(event); // synchronous call to async EventRouter.route()",
      "impact": "Memory pressure under burst traffic from Laravel (mass events)",
      "repro": "Publish 1000 events/second on Redis channel and monitor Node.js heap",
      "fix": "Add bounded event queue or unprocessed event counter metric",
      "complexity": "Medium",
      "docsPath": ""
    },
    {
      "id": "SEC-010",
      "severity": "MEDIUM",
      "dimension": "Security",
      "file": "src/auth/jwtValidator.ts",
      "function": "verifyJwtInternal",
      "problem": "JWT revocation check fail-closed on Redis error but has no Prometheus metric for alerting",
      "evidence": "catch (err) { logger.error(...); return null; } // No metrics.authAttempts.inc",
      "impact": "Redis outage silently rejects all new connections with no dashboard visibility",
      "repro": "Stop Redis, attempt socket connection, verify no prometheus metric recorded",
      "fix": "Add metrics.authAttempts.inc({ result: 'redis_error' }) to catch block",
      "complexity": "Trivial",
      "docsPath": ""
    },
    {
      "id": "REL-010",
      "severity": "MEDIUM",
      "dimension": "Reliability",
      "file": "src/domains/gift/giftBuffer.ts",
      "function": "GiftBuffer.flush",
      "problem": "Catches empty queue by string-matching 'no such key' in error message — fragile",
      "evidence": "if (errorMessage.toLowerCase().includes('no such key')) { return; }",
      "impact": "Redis error message format changes could cause false error logging",
      "repro": "Run flush with empty queue on different Redis versions and check error message",
      "fix": "Use EXISTS before RENAME, or Lua atomic check, or catch Redis error code",
      "complexity": "Low",
      "docsPath": "https://redis.io/commands/rename/"
    },
    {
      "id": "REL-011",
      "severity": "LOW",
      "dimension": "Reliability",
      "file": "src/domains/gift/giftBuffer.ts",
      "function": "GiftBuffer.flush",
      "problem": "Success metric incremented in a loop instead of single .inc({}, count) call",
      "evidence": "for (let i = 0; i < successCount; i++) { metrics.giftsProcessed.inc({ status: 'success' }); }",
      "impact": "Marginal CPU waste for large batches",
      "repro": "Process 1000-gift batch and profile inc() calls",
      "fix": "Use metrics.giftsProcessed.inc({ status: 'success' }, successCount)",
      "complexity": "Trivial",
      "docsPath": "https://github.com/siimon/prom-client#counter"
    }
  ],
  "overEngineering": []
}
