# Chat Domain — Forensic Audit Report

**Date:** 2026-02-12 10:30 PKT  
**Scope:** `src/domains/chat/` + related schemas, config, and infrastructure  
**Files Reviewed:** 6 files (handler, barrel, schema, config, handler utils, rate limiter)

---

## Executive Summary

The Chat domain is the **smallest domain** in the codebase — 2 files, 61 LOC, 1 socket event (`chat:message`). It correctly leverages the shared `createHandler` pattern for validation and error handling, and integrates rate limiting and auto-close activity recording.

However, the audit uncovered **1 HIGH**, **3 MEDIUM**, and **3 LOW** findings related to missing room membership authorization, rate-limit scoping, schema validation gaps, and zero test coverage.

---

## Domain Coverage Matrix

| File                                                                                                                       | Lines            | Purpose                | Issues                |
| -------------------------------------------------------------------------------------------------------------------------- | ---------------- | ---------------------- | --------------------- |
| [chat.handler.ts](file:///home/xha/FlyLive/mediasoup-socket-io-audio-broadcasting-server/src/domains/chat/chat.handler.ts) | 54               | Single message handler | CF-001 through CF-005 |
| [index.ts](file:///home/xha/FlyLive/mediasoup-socket-io-audio-broadcasting-server/src/domains/chat/index.ts)               | 7                | Barrel export          | CF-006                |
| [schemas.ts](file:///home/xha/FlyLive/mediasoup-socket-io-audio-broadcasting-server/src/socket/schemas.ts#L175-L179)       | 5 (chat section) | `chatMessageSchema`    | CF-003                |

---

## Findings by Severity

### CF-001 — Missing Room Membership Authorization

```
Severity: HIGH
File: src/domains/chat/chat.handler.ts
Function: handleChatMessage
Problem: No verification that the sender belongs to the target room before broadcasting
Evidence: `socket.nsp.to(payload.roomId).emit("chat:message", message);`
Impact: Any authenticated user can inject chat messages into rooms they haven't joined
Repro: Connect socket → emit chat:message with arbitrary roomId → message appears in that room
Fix: Guard with `if (!socket.rooms.has(payload.roomId)) return { success: false, error: "Not in room" };`
Complexity: 0.5h
```

**Analysis:** Other domains (seat, media) implicitly enforce room membership through state lookups (e.g., seat repository, transport maps). Chat skips this entirely because it has no server-side state — it's a pure broadcast relay. A single `socket.rooms.has()` check (O(1) Set lookup, zero Redis cost) closes this gap.

---

### CF-002 — Rate-Limit Key Scoped Per-User Instead of Per-User-Per-Room

```
Severity: MEDIUM
File: src/domains/chat/chat.handler.ts:16-20
Function: handleChatMessage (rate limiter call)
Problem: Rate limit key is `chat:${userId}` — global across all rooms
Evidence: `context.rateLimiter.isAllowed(`chat:${userId}`, config.RATE_LIMIT_MESSAGES_PER_MINUTE, 60)`
Impact: A user chatting in Room A depletes their budget for Room B; unfair throttling in multi-room scenarios
Fix: Change key to `chat:${userId}:${payload.roomId}` for per-room isolation
Complexity: 0.25h
```

> [!NOTE]
> If the product currently supports only one room per user at a time, the impact is negligible. However, the fix is trivial and future-proofs the design.

---

### CF-003 — `type` Field Lacks Allowlist Validation

```
Severity: MEDIUM
File: src/socket/schemas.ts:178
Function: chatMessageSchema
Problem: `type` is z.string().optional() — accepts any arbitrary string
Evidence: `type: z.string().optional(),`
Impact: Frontend could send unsupported types (e.g., "html", "script"), causing rendering bugs or XSS if client-side rendering trusts this field
Fix: `type: z.enum(["text", "emoji", "sticker", "system"]).default("text")` — whitelist known types
Complexity: 0.5h
```

---

### CF-004 — Sender Excluded from Own Broadcast

```
Severity: MEDIUM
File: src/domains/chat/chat.handler.ts:37
Function: handleChatMessage
Problem: Code comment says "INCLUDING sender" but `socket.nsp.to(roomId).emit()` EXCLUDES the sender
Evidence: `.to(payload.roomId).emit("chat:message", message)` — Socket.IO's `.to()` excludes the current socket
Impact: Sender won't see their own message in the room unless frontend adds it optimistically (fragile, may cause dual render if fixed later)
Fix: Two options:
  (a) Use `socket.nsp.in(payload.roomId).emit(...)` — includes sender
  (b) Keep `.to()` but document that frontend must add message optimistically
Complexity: 0.25h
```

> [!IMPORTANT]
> This is a **factual correctness** issue in the comment, and potentially a **behavioral bug** depending on frontend expectations. Verify with frontend team whether optimistic insertion is implemented.

---

### CF-005 — Silent Error Swallowing on Auto-Close Activity

```
Severity: LOW
File: src/domains/chat/chat.handler.ts:40
Function: handleChatMessage
Problem: `autoCloseService.recordActivity()` errors are silently swallowed with `.catch(() => {})`
Evidence: `context.autoCloseService.recordActivity(payload.roomId).catch(() => {});`
Impact: If Redis connectivity degrades, rooms may auto-close during active chat with zero visibility
Fix: Log at debug/warn level: `.catch((err) => logger.debug({ err, roomId: payload.roomId }, "recordActivity failed"))`
Complexity: 0.25h
```

---

### CF-006 — Barrel Export Bypassed in Domain Registry

```
Severity: LOW
File: src/domains/index.ts:17
Function: domain registration imports
Problem: Imports `chatHandler` directly from `./chat/chat.handler.js` instead of `./chat/index.js`
Evidence: `import { chatHandler } from "./chat/chat.handler.js";`
Impact: Barrel export in `chat/index.ts` becomes dead code; bypasses any future re-exports
Fix: Change to `import { chatHandler } from "./chat/index.js";`
Complexity: 0.1h
```

---

### CF-007 — Zero Test Coverage

```
Severity: LOW
File: src/domains/chat/ (entire domain)
Function: N/A
Problem: No unit or integration tests exist for the chat handler
Evidence: No *.test.ts or *.spec.ts files found for chat domain
Impact: Regressions in rate limiting, room authorization, or message broadcasting go undetected
Fix: Add chat.handler.test.ts covering: valid message, rate limit rejection, room membership check, schema validation
Complexity: 2h
```

---

## Over-Engineering Assessment

**No over-engineering detected.** The Chat domain is lean and appropriate for its scope:

- Single handler for a single event ✓
- Reuses shared `createHandler` pattern ✓
- No unnecessary abstractions, repositories, or service layers ✓
- No premature optimization ✓

---

## Dead / Redundant Code

| Location                                                 | Type             | Description                                                                                                |
| -------------------------------------------------------- | ---------------- | ---------------------------------------------------------------------------------------------------------- |
| `chat/index.ts`                                          | Partially dead   | Barrel export exists but is bypassed by the domain registry                                                |
| Line 13 `const userId = ...` then re-accessed on line 28 | Redundant access | `userId` declared on L13, but `socket.data.user.id` is accessed again on L28 instead of using the variable |

---

## Aggregate Scores (Chat Domain)

| Dimension                  | Weight  | Score (0-10) | Weighted     |
| -------------------------- | ------- | ------------ | ------------ |
| Performance & Efficiency   | 30      | 8.5          | 25.5         |
| Architecture & Scalability | 20      | 8.0          | 16.0         |
| Realtime Correctness       | 15      | 6.0          | 9.0          |
| Code Quality               | 15      | 7.0          | 10.5         |
| Security & Reliability     | 10      | 5.5          | 5.5          |
| Readability                | 10      | 9.0          | 9.0          |
| **Total**                  | **100** |              | **75.5/100** |

---

## Priority Remediation Queue

| Priority | ID     | Severity | Fix                                                   | Effort |
| -------- | ------ | -------- | ----------------------------------------------------- | ------ |
| 1        | CF-001 | HIGH     | Add `socket.rooms.has()` room membership check        | 0.5h   |
| 2        | CF-004 | MEDIUM   | Fix `.to()` → `.in()` or document optimistic approach | 0.25h  |
| 3        | CF-003 | MEDIUM   | Whitelist `type` values in schema                     | 0.5h   |
| 4        | CF-002 | MEDIUM   | Scope rate-limit key per room                         | 0.25h  |
| 5        | CF-005 | LOW      | Log auto-close errors instead of swallowing           | 0.25h  |
| 6        | CF-006 | LOW      | Use barrel import in domain registry                  | 0.1h   |
| 7        | CF-007 | LOW      | Add unit tests for chat handler                       | 2h     |

**Total estimated effort: ~3.85h**
