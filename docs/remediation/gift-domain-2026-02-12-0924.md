# Gift Domain — Remediation Plan

| Key | Value |
|---|---|
| Date | 2026-02-12 09:24 PKT |
| Audit Ref | `reports/audit-gift-domain-2026-02-12-0835.json` |
| Commit | `407ed04` |
| Branch | `work` |

---

## 1. Executive Summary

Comprehensive remediation for all 11 findings from the Gift domain forensic audit. Changes are organized into **3 atomic PRs** totaling ~8.5 hours of effort. No breaking protocol changes.

---

## 2. Per-Issue Remediation Details

### GF-001 — Room Membership Validation

```
Issue ID: GF-001
Severity: HIGH
Files Touched:
  - src/shared/errors.ts
  - src/domains/gift/giftHandler.ts

Patch Sketch:
  + Add NOT_IN_ROOM to Errors object
  + Add sock.rooms.has(payload.roomId) guard in gift:send and gift:prepare

Downstream Callsites:
  - src/domains/gift/giftHandler.ts:32 — gift:send handler
  - src/domains/gift/giftHandler.ts:78 — gift:prepare handler

Runtime Risk: Legitimate users who somehow lost room membership will get rejected
Rollback: git revert <commit>
Hours: 0.5
Owner: Backend
Priority: P0
Docs Updates:
  - docs/audits/gift-domain-2026-02-12-0835.md — Mark GF-001 resolved

Tests Required:
  - tests/unit/domains/gift/giftHandler.test.ts — "rejects gift:send when sender not in room"
  - tests/unit/domains/gift/giftHandler.test.ts — "rejects gift:prepare when sender not in room"
```

---

### GF-002 — Unit Test Coverage

```
Issue ID: GF-002
Severity: HIGH
Files Touched:
  - tests/unit/domains/gift/giftHandler.test.ts (NEW)
  - tests/unit/domains/gift/giftBuffer.test.ts (NEW)

Patch Sketch:
  + Create test suites with vitest mocks for Redis, LaravelClient, Socket.IO
  + Cover: enqueue, flush, retry, dead-letter, rate-limiting, room validation

Downstream Callsites: None (new files)

Runtime Risk: None
Rollback: git revert <commit>
Hours: 4
Owner: Backend
Priority: P0
Docs Updates: None

Tests Required:
  - tests/unit/domains/gift/giftHandler.test.ts — 6+ test cases
  - tests/unit/domains/gift/giftBuffer.test.ts — 7+ test cases
```

---

### GF-003 — Robust JSON Parsing

```
Issue ID: GF-003
Severity: MEDIUM
Files Touched:
  - src/domains/gift/giftBuffer.ts

Patch Sketch:
  - items.map((item) => JSON.parse(item))
  + Per-item try/catch loop; corrupted entries → dead-letter queue

Downstream Callsites:
  - src/domains/gift/giftBuffer.ts:85 — flush()

Runtime Risk: None (strictly more resilient)
Rollback: git revert <commit>
Hours: 1
Owner: Backend
Priority: P1
Docs Updates: None

Tests Required:
  - tests/unit/domains/gift/giftBuffer.test.ts — "handles corrupted JSON entries gracefully"
```

---

### GF-004 — Rate-Limit gift:prepare

```
Issue ID: GF-004
Severity: MEDIUM
Files Touched:
  - src/domains/gift/giftHandler.ts

Patch Sketch:
  + Add rateLimiter.isAllowed(`gift:prepare:${user.id}`, ...) check

Downstream Callsites:
  - src/domains/gift/giftHandler.ts:78 — gift:prepare handler

Runtime Risk: Legitimate rapid prepare signals could be throttled (330/min is generous)
Rollback: git revert <commit>
Hours: 0.5
Owner: Backend
Priority: P1
Docs Updates: None

Tests Required:
  - tests/unit/domains/gift/giftHandler.test.ts — "rate-limits gift:prepare"
```

---

### GF-005 — Targeted gift:prepare Emit

```
Issue ID: GF-005
Severity: MEDIUM
Files Touched:
  - src/domains/gift/giftHandler.ts

Patch Sketch:
  - sock.to(payload.roomId).emit("gift:prepare", ...)
  + const socketIds = await context.userSocketRepository.getSocketIds(payload.recipientId)
  + context.io.to(socketIds).emit("gift:prepare", ...)

Downstream Callsites:
  - src/domains/gift/giftHandler.ts:80 — gift:prepare broadcast

Runtime Risk: If recipient has no active sockets, prepare signal is silently dropped (acceptable — gift:send still works)
Rollback: git revert <commit>
Hours: 1
Owner: Backend
Priority: P1
Docs Updates: None

Tests Required:
  - tests/unit/domains/gift/giftHandler.test.ts — "emits gift:prepare only to recipient sockets"
```

---

### GF-006 — Dead-Letter Queue Bounds

```
Issue ID: GF-006
Severity: MEDIUM
Files Touched:
  - src/domains/gift/giftBuffer.ts
  - src/infrastructure/metrics.ts

Patch Sketch:
  + Add DEAD_LETTER_MAX_LENGTH = 10_000
  + pipeline.ltrim(DEAD_LETTER_KEY, -10000, -1) after rpush
  + Add giftDeadLetterSize Gauge metric

Downstream Callsites:
  - src/domains/gift/giftBuffer.ts:129 — dead-letter rpush
  - src/infrastructure/metrics.ts — metrics object

Runtime Risk: Oldest dead-letter entries evicted if > 10k (acceptable data loss for failed gifts)
Rollback: git revert <commit>
Hours: 0.5
Owner: Backend
Priority: P1
Docs Updates: None

Tests Required:
  - tests/unit/domains/gift/giftBuffer.test.ts — "caps dead-letter queue with LTRIM"
```

---

### GF-007 — Instance-Unique Processing Key

```
Issue ID: GF-007
Severity: MEDIUM
Files Touched:
  - src/domains/gift/giftBuffer.ts

Patch Sketch:
  - `${this.QUEUE_KEY}:processing:${Date.now()}`
  + `${this.QUEUE_KEY}:processing:${process.pid}:${Date.now()}`

Downstream Callsites:
  - src/domains/gift/giftBuffer.ts:68 — flush()

Runtime Risk: None
Rollback: git revert <commit>
Hours: 0.25
Owner: Backend
Priority: P1
Docs Updates: None

Tests Required:
  - tests/unit/domains/gift/giftBuffer.test.ts — "processing key includes process.pid"
```

---

### GF-008 — Explicit gift:received Fields

```
Issue ID: GF-008
Severity: LOW
Files Touched:
  - src/domains/gift/giftHandler.ts

Patch Sketch:
  - { senderId: user.id, ...payload }
  + { senderId: user.id, roomId: payload.roomId, giftId: payload.giftId, recipientId: payload.recipientId, quantity: payload.quantity }

Downstream Callsites:
  - src/domains/gift/giftHandler.ts:57 — gift:send broadcast

Runtime Risk: None (same fields emitted, just explicit)
Rollback: git revert <commit>
Hours: 0.25
Owner: Backend
Priority: P2
Docs Updates: None

Tests Required:
  - tests/unit/domains/gift/giftHandler.test.ts — "emits only expected fields in gift:received"
```

---

### GF-009 — Remove Duplicate RateLimiter

```
Issue ID: GF-009
Severity: LOW
Files Touched:
  - src/domains/gift/giftHandler.ts

Patch Sketch:
  - private readonly rateLimiter: RateLimiter
  - this.rateLimiter = new RateLimiter(redis)
  + Use context.rateLimiter in handler callbacks

Downstream Callsites:
  - src/domains/gift/giftHandler.ts:36 — gift:send rate limit
  - src/domains/gift/giftHandler.ts (new) — gift:prepare rate limit

Runtime Risk: None (same Redis instance, same key prefix)
Rollback: git revert <commit>
Hours: 0.25
Owner: Backend
Priority: P2
Docs Updates: None

Tests Required:
  - tests/unit/domains/gift/giftHandler.test.ts — verify context.rateLimiter is called
```

---

### GF-010 — Use Error Constant

```
Issue ID: GF-010
Severity: INFO
Files Touched:
  - src/domains/gift/giftHandler.ts

Patch Sketch:
  - error: "Too many gifts, please slow down"
  + error: Errors.RATE_LIMITED

Downstream Callsites:
  - src/domains/gift/giftHandler.ts:42 — rate limit response

Runtime Risk: Frontend clients checking exact string will see different message
Rollback: git revert <commit>
Hours: 0.1
Owner: Backend
Priority: P3
Docs Updates: None

Tests Required: Covered by GF-004 test
```

---

### GF-011 — Remove Unused Barrel Export

```
Issue ID: GF-011
Severity: INFO
Files Touched:
  - src/domains/gift/index.ts

Patch Sketch:
  - export { GiftBuffer } from "./giftBuffer.js"

Downstream Callsites: None (no external imports found)

Runtime Risk: None
Rollback: git revert <commit>
Hours: 0.1
Owner: Backend
Priority: P3
Docs Updates: None

Tests Required: None (verified by typecheck)
```

---

## 3. Atomic PR Plan

| PR # | Title | Findings | Files | Depends On |
|---|---|---|---|---|
| 1 | fix(gift): room membership validation + security hardening | GF-001, GF-004, GF-008, GF-010 | 2 | — |
| 2 | perf(gift): robust buffer + targeted emit + scaling fixes | GF-003, GF-005, GF-006, GF-007 | 3 | PR #1 |
| 3 | refactor(gift): architecture cleanup + unit tests | GF-002, GF-009, GF-011 | 4 | PR #2 |

---

## 4. Sprint Plan

| Sprint | Focus | PRs | Hours |
|---|---|---|---|
| 1 | Security + Performance + Tests | 1, 2, 3 | 8.5 |

All changes fit in a single sprint — the Gift domain is small.

---

## 5. Rollback Procedures

Each PR is atomic and independently revertable:

```bash
# Revert specific PR
git revert <merge-commit-sha>

# Emergency: revert all 3 PRs at once
git revert <pr3-sha> <pr2-sha> <pr1-sha>
```

No database migrations. No config changes. No protocol changes.
