# Remediation Report — Supporting Layers

**Date**: 2026-02-10T09:22  
**Audit Ref**: `reports/audit-2026-02-10-0900-supporting-layers.json`  
**Commit**: `37734a7` (pre-remediation)

---

## Executive Summary

Remediated **12 of 14** findings from the supporting layers audit. All 4 quality gates pass post-remediation (typecheck, lint, 25/25 tests, build). Two findings deferred (SL-010 schema co-location, SL-014 AppContext god object) as they require cross-domain refactoring.

| Gate                | Result       |
| ------------------- | ------------ |
| `npm run typecheck` | ✅ Pass      |
| `npm run lint`      | ✅ Pass      |
| `npm run test`      | ✅ 25/25     |
| `npm run build`     | ✅ 125.57 KB |

---

## Remediations Applied

### SL-001 · Health Endpoint Minimized (MEDIUM → Fixed)

**Files**: `src/infrastructure/health.ts`, `src/infrastructure/server.ts`

- Removed Redis status details, worker PIDs, room count, and build info
- Removed `getVersionInfo()` function and `fs`/`path` imports
- Now returns only: `status`, `uptime`, `timestamp`
- Removed `RoomManager` parameter from `createHealthRoutes`
- Updated callsite in `server.ts`

---

### SL-002 · Redis Disconnect Export (MEDIUM → Fixed)

**Files**: `src/infrastructure/redis.ts`

- Added `disconnectRedis()` async function
- Calls `redisInstance.quit()` and resets singleton to `null`

---

### SL-003 · JSON.parse Guard in Event Subscriber (MEDIUM → Fixed)

**Files**: `src/integrations/laravel/event-subscriber.ts`

- Wrapped `JSON.parse` in try/catch within `parseEvent`
- Returns `null` with specific `"Malformed JSON in event message"` warning
- Changed `parsed` type from implicit `object` to explicit `unknown` → `Record<string, unknown>`
- All downstream property accesses now use properly typed `obj` alias

---

### SL-004 · Batched Socket Emission (MEDIUM → Fixed)

**Files**: `src/integrations/laravel/event-router.ts`

- `emitToUser`: Chains `.to()` calls for a single adapter call instead of N separate emits
- `emitToUserInRoom`: Same optimization applied
- Reduces Redis adapter round-trips for multi-socket users

---

### SL-005 · Extracted Disconnect Handler (MEDIUM → Fixed)

**Files**: `src/socket/index.ts`

- Extracted inline `socket.on("disconnect", ...)` callback into named `handleDisconnect` function
- Added `DisconnectDeps` interface for dependency injection
- Improves testability and readability

---

### SL-006 · Consolidated Crypto Utilities (MEDIUM → Fixed)

**Files**: `src/shared/crypto.ts` (NEW), `src/shared/index.ts`, `src/shared/handler.utils.ts`, `src/auth/jwtValidator.ts`  
**Deleted**: `src/utils/crypto.ts`, `src/shared/correlation.ts`

- Created `shared/crypto.ts` combining `generateCorrelationId` + `hashToken`
- Updated barrel export and all import paths
- Deleted redundant files

---

### SL-007 · Logger DI in UserSocketRepository (MEDIUM → Fixed)

**Files**: `src/integrations/laravel/user-socket.repository.ts`, `src/socket/index.ts`

- Changed constructor: `constructor(redis: Redis)` → `constructor(redis: Redis, logger: Logger)`
- Replaced all 15 bare `logger.` calls with `this.logger.`
- Updated callsite to pass `logger` instance

---

### SL-008 · Removed onAny Debug Listener (LOW → Fixed)

**Files**: `src/socket/index.ts`

- Removed 9-line `socket.onAny()` block that ran on every event in production
- Was filtering for `seat:lock` and `seat:invite` — temporary debug code

---

### SL-009 · Removed Unused cpuUsage Tracking (LOW → Fixed)

**Files**: `src/infrastructure/worker.manager.ts`

- Removed `cpuUsage` field from `WorkerInfo` interface
- Removed `updateAllCpuUsage()` private method
- Removed `lastCpuUpdate` and `CPU_UPDATE_INTERVAL` fields
- `getLeastLoadedWorker()` changed from `async` → synchronous (no more `getResourceUsage()` calls)

---

### SL-012 · Parallelized Disconnect Cleanup (LOW → Fixed)

**Files**: `src/socket/index.ts`

- Combined with SL-005 disconnect extraction
- `unregisterSocket` and `clearUserRoom` now run via `Promise.allSettled`
- Independent Redis operations execute in parallel

---

### SL-013 · Boolean Env Schema Helper (LOW → Fixed)

**Files**: `src/config/index.ts`

- Extracted `booleanEnvSchema` helper for `"true"/"1"` → `true` transform
- Applied to `REDIS_TLS` and `MSAB_EVENTS_ENABLED` fields
- Eliminates duplicate 4-line transform pattern

---

## Deferred

| ID     | Severity | Reason                                                                                           |
| ------ | -------- | ------------------------------------------------------------------------------------------------ |
| SL-010 | LOW      | Schema co-location requires touching 4+ domain handler imports — better as dedicated refactor PR |
| SL-014 | INFO     | AppContext god object — architectural redesign scope, not a quick fix                            |

---

## Rollback

All changes are in the supporting layers only. Revert with:

```bash
git revert HEAD
```
