# Relay Domain Remediation Plan

> **Audit Reference**: `reports/audit-2026-02-13-0918.json`  
> **Date**: 2026-02-13  
> **Branch**: `work` · **Commit**: `28ec11d`  
> **Scope**: `src/integrations/laravel/` (5 files, 830 lines)  
> **Total Findings**: 10 (1 HIGH, 3 MEDIUM, 3 LOW, 3 INFO)  
> **Total Estimated Hours**: 8.25h

---

## Executive Summary

The Relay domain is architecturally sound but has a logic bug in backpressure detection, dead code accumulation, and zero test coverage. This plan organizes fixes into **3 atomic PRs** ordered by risk: (1) bug fixes + dead code removal, (2) performance + observability, (3) test coverage. All changes are backward-compatible with zero API surface impact.

---

## Per-Issue Remediation Details

---

### RL-001 — Backpressure Check After Decrement

```
Issue ID: RL-001
Severity: HIGH
Files Touched:
  - src/integrations/laravel/event-subscriber.ts

Patch Sketch:
```

```diff
--- a/src/integrations/laravel/event-subscriber.ts
+++ b/src/integrations/laravel/event-subscriber.ts
@@ -59,6 +59,13 @@
       metrics.laravelEventsInFlight.inc();
       this.inFlightCount++;

+      // Backpressure detection: check immediately after increment
+      if (this.inFlightCount > BACKPRESSURE_THRESHOLD) {
+        this.logger.warn(
+          { inFlight: this.inFlightCount, threshold: BACKPRESSURE_THRESHOLD },
+          "Laravel event subscriber backpressure detected",
+        );
+      }
+
       try {
         const event = this.parseEvent(message);
@@ -80,11 +87,6 @@
       } finally {
         metrics.laravelEventsInFlight.dec();
         this.inFlightCount--;
-
-        if (this.inFlightCount > BACKPRESSURE_THRESHOLD) {
-          this.logger.warn(
-            { inFlight: this.inFlightCount, threshold: BACKPRESSURE_THRESHOLD },
-            "Laravel event subscriber backpressure detected",
-          );
-        }
       }
```

```
Downstream Callsites:
  - src/socket/index.ts:68 — new LaravelEventSubscriber(...)

Runtime Risk: None — only changes when the warn log fires, not routing behavior
Rollback: git revert <commit>
Hours: 0.5
Owner: Backend
Priority: P0
Docs Updates:
  - docs/Events/Relay/README.md — update backpressure section
Tests Required:
  - tests/unit/integrations/laravel/event-subscriber.test.ts — "should warn when inFlightCount exceeds threshold"
```

---

### RL-002 — Dead Methods in UserSocketRepository

```
Issue ID: RL-002
Severity: MEDIUM
Files Touched:
  - src/integrations/laravel/user-socket.repository.ts

Patch Sketch:
```

```diff
--- a/src/integrations/laravel/user-socket.repository.ts
+++ b/src/integrations/laravel/user-socket.repository.ts
@@ -83,42 +83,6 @@
   }

-  /**
-   * Check if a user has any active sockets
-   */
-  async hasActiveSockets(userId: number): Promise<boolean> {
-    try {
-      const key = USER_SOCKETS_KEY(userId);
-      const count = await this.redis.scard(key);
-      return count > 0;
-    } catch (err) {
-      this.logger.error({ err, userId }, "Failed to check active sockets");
-      return false;
-    }
-  }
-
-  /**
-   * Clear all sockets for a user
-   * Used during cleanup or force logout
-   */
-  async clearUser(userId: number): Promise<boolean> {
-    try {
-      const key = USER_SOCKETS_KEY(userId);
-      await this.redis.del(key);
-      this.logger.debug({ userId }, "Cleared all sockets for user");
-      return true;
-    } catch (err) {
-      this.logger.error({ err, userId }, "Failed to clear user sockets");
-      return false;
-    }
-  }
-
-  /**
-   * Get count of active sockets for a user
-   */
-  async getSocketCount(userId: number): Promise<number> {
-    try {
-      const key = USER_SOCKETS_KEY(userId);
-      return await this.redis.scard(key);
-    } catch (err) {
-      this.logger.error({ err, userId }, "Failed to get socket count");
-      return 0;
-    }
-  }
-
   // ─────────────────────────────────────────────────────────────────
```

```
Downstream Callsites: NONE (confirmed dead code)
Runtime Risk: None — methods are never called
Rollback: git revert <commit>
Hours: 0.5
Owner: Backend
Priority: P1
Docs Updates: None
Tests Required: None (removing dead code)
```

---

### RL-003 — Inline Lua Script Re-parsed on Every Call

```
Issue ID: RL-003
Severity: MEDIUM
Files Touched:
  - src/integrations/laravel/user-socket.repository.ts

Patch Sketch:
```

```diff
--- a/src/integrations/laravel/user-socket.repository.ts
+++ b/src/integrations/laravel/user-socket.repository.ts
@@ -13,6 +13,14 @@
 // TTL for socket entries (24 hours - cleanup for stale entries)
 const SOCKET_TTL_SECONDS = 86400;

+// Lua: atomic SREM + conditional DEL (pre-allocated to avoid per-call string creation)
+const UNREGISTER_SOCKET_LUA = `
+  redis.call('srem', KEYS[1], ARGV[1])
+  if redis.call('scard', KEYS[1]) == 0 then
+    redis.call('del', KEYS[1])
+  end
+  return 1
+`;
+
 export class UserSocketRepository {
@@ -52,12 +60,7 @@
     try {
       const key = USER_SOCKETS_KEY(userId);
-      // PERF-005 FIX: Atomic SREM + conditional DEL in single Lua round-trip
-      const UNREGISTER_LUA = `
-        redis.call('srem', KEYS[1], ARGV[1])
-        if redis.call('scard', KEYS[1]) == 0 then
-          redis.call('del', KEYS[1])
-        end
-        return 1
-      `;
-      await this.redis.eval(UNREGISTER_LUA, 1, key, socketId);
+      await this.redis.eval(UNREGISTER_SOCKET_LUA, 1, key, socketId);
```

```
Downstream Callsites:
  - src/socket/index.ts:193 — userSocketRepository.unregisterSocket(...)
  - src/socket/index.ts:217 — userSocketRepository.unregisterSocket(...)

Runtime Risk: None — same Lua semantics, only memory allocation changes
Rollback: git revert <commit>
Hours: 0.5
Owner: Backend
Priority: P1
Docs Updates: None
Tests Required:
  - tests/unit/integrations/laravel/user-socket.repository.test.ts — "should atomically remove socket and delete empty set"
```

---

### RL-004 — Processing Duration Measures Sync Parse Only

```
Issue ID: RL-004
Severity: MEDIUM
Files Touched:
  - src/integrations/laravel/event-subscriber.ts
  - src/integrations/laravel/event-router.ts

Patch Sketch:
```

```diff
--- a/src/integrations/laravel/event-subscriber.ts
+++ b/src/integrations/laravel/event-subscriber.ts
@@ -58,7 +58,6 @@

-      const startTime = Date.now();
       metrics.laravelEventsInFlight.inc();
       this.inFlightCount++;

@@ -65,12 +64,6 @@
         const event = this.parseEvent(message);
         if (event) {
           this.onEvent(event);
-
-          const durationSec = (Date.now() - startTime) / 1000;
-          metrics.laravelEventProcessingDuration.observe(
-            { event_type: event.event },
-            durationSec,
-          );
         }
```

```diff
--- a/src/integrations/laravel/event-router.ts
+++ b/src/integrations/laravel/event-router.ts
@@ -70,6 +70,12 @@
       const durationMs = Date.now() - startTime;

+      // Record actual routing duration (includes async Redis lookups + emit)
+      const durationSec = durationMs / 1000;
+      metrics.laravelEventProcessingDuration.observe(
+        { event_type: event.event },
+        durationSec,
+      );
+
       this.logger.debug(
```

```
Downstream Callsites:
  - src/socket/index.ts:71 — eventRouter.route(event)

Runtime Risk: Minimal — moving metric observation point; values will now be higher (correct)
Rollback: git revert <commit>
Hours: 1.0
Owner: Backend
Priority: P1
Docs Updates:
  - docs/Events/Relay/README.md — note that duration metric now includes routing latency
Tests Required:
  - tests/unit/integrations/laravel/event-router.test.ts — "should observe processing duration for routed events"
```

---

### RL-005 — Dead KNOWN_EVENTS and KnownEventType Exports

```
Issue ID: RL-005
Severity: LOW
Files Touched:
  - src/integrations/laravel/types.ts
  - src/integrations/laravel/index.ts

Patch Sketch:
```

```diff
--- a/src/integrations/laravel/types.ts
+++ b/src/integrations/laravel/types.ts
@@ -107,6 +107,7 @@
 /**
  * Flat lookup for backward compatibility.
  * Prefer using RELAY_EVENTS.<domain> for domain-specific access.
+ * @deprecated Use RELAY_EVENTS.<domain> instead. Will be removed in next major.
  */
 export const KNOWN_EVENTS = {
@@ -121,1 +122,2 @@
+/** @deprecated Use RELAY_EVENTS values instead */
 export type KnownEventType = (typeof KNOWN_EVENTS)[keyof typeof KNOWN_EVENTS];
```

```
Downstream Callsites: NONE (only barrel export in index.ts)
Runtime Risk: None — deprecation annotation only
Rollback: git revert <commit>
Hours: 0.5
Owner: Backend
Priority: P2
Docs Updates:
  - docs/Events/Relay/README.md — note deprecation of KNOWN_EVENTS
Tests Required: None
```

---

### RL-006 — Dead messageBuffer Handler

```
Issue ID: RL-006
Severity: LOW
Files Touched:
  - src/integrations/laravel/event-subscriber.ts

Patch Sketch:
```

```diff
--- a/src/integrations/laravel/event-subscriber.ts
+++ b/src/integrations/laravel/event-subscriber.ts
@@ -92,6 +92,0 @@
-    // Some ioredis versions use messageBuffer instead
-    this.subscriber.on("messageBuffer", (_channel, _message) => {
-      this.logger.debug("Redis messageBuffer received (buffer mode)");
-    });
-
```

```
Downstream Callsites: None
Runtime Risk: If ioredis sends messageBuffer events, they will be unhandled (same effective behavior as current — events were already silently dropped)
Rollback: git revert <commit>
Hours: 0.5
Owner: Backend
Priority: P2
Docs Updates: None
Tests Required: None
```

---

### RL-007 — Optional Chaining on Always-defined Metric

```
Issue ID: RL-007
Severity: LOW
Files Touched:
  - src/integrations/laravel/event-router.ts

Patch Sketch:
```

```diff
--- a/src/integrations/laravel/event-router.ts
+++ b/src/integrations/laravel/event-router.ts
@@ -85,1 +85,1 @@
-      metrics.laravelEventsReceived?.inc({
+      metrics.laravelEventsReceived.inc({
```

```
Downstream Callsites: None (metric usage only)
Runtime Risk: None — metric is always initialized at module load
Rollback: git revert <commit>
Hours: 0.25
Owner: Backend
Priority: P3
Docs Updates: None
Tests Required: None
```

---

### RL-008 — Zero Unit Test Coverage

```
Issue ID: RL-008
Severity: INFO
Files Touched:
  - tests/unit/integrations/laravel/event-router.test.ts [NEW]
  - tests/unit/integrations/laravel/event-subscriber.test.ts [NEW]
  - tests/unit/integrations/laravel/user-socket.repository.test.ts [NEW]

Patch Sketch: (new files — no diff, outline below)
```

**event-router.test.ts** test cases:
- `should emit to user sockets when user_id set`
- `should emit to room when room_id set`
- `should emit to user sockets in room when both set`
- `should broadcast when neither set`
- `should return delivered:false when user has no sockets`
- `should return delivered:false when room is empty`
- `should record metrics after routing`

**event-subscriber.test.ts** test cases:
- `should parse valid JSON event`
- `should reject malformed JSON`
- `should reject missing event type`
- `should reject invalid user_id type`
- `should reject invalid room_id type`
- `should default timestamp and correlation_id`
- `should track inFlight gauge`

**user-socket.repository.test.ts** test cases:
- `should register socket for user`
- `should unregister socket and delete empty set`
- `should return all socket IDs`
- `should set and get user room`
- `should clear user room`

```
Downstream Callsites: N/A (new test files)
Runtime Risk: None — test-only changes
Rollback: Delete test files
Hours: 3.0
Owner: Backend
Priority: P1
Docs Updates: None
Tests Required: (these ARE the tests)
```

---

### RL-009 — No Event Allowlist Validation

```
Issue ID: RL-009
Severity: INFO
Files Touched:
  - src/integrations/laravel/event-subscriber.ts
  - src/integrations/laravel/types.ts

Patch Sketch:
```

```diff
--- a/src/integrations/laravel/types.ts
+++ b/src/integrations/laravel/types.ts
@@ +123,0
+/** Set of all known relay event names for validation */
+export const KNOWN_EVENT_NAMES: ReadonlySet<string> = new Set(
+  Object.values(KNOWN_EVENTS),
+);
```

```diff
--- a/src/integrations/laravel/event-subscriber.ts
+++ b/src/integrations/laravel/event-subscriber.ts
@@ -9,1 +9,2 @@
 import type { LaravelEvent } from "./types.js";
+import { KNOWN_EVENT_NAMES } from "./types.js";

@@ +67,0
+          // Warn on unknown events (don't block — preserve pass-through)
+          if (!KNOWN_EVENT_NAMES.has(event.event)) {
+            this.logger.warn(
+              { event: event.event },
+              "Unknown relay event received — not in RELAY_EVENTS registry",
+            );
+          }
```

```
Downstream Callsites:
  - src/socket/index.ts:68 — new LaravelEventSubscriber(...)

Runtime Risk: Minimal — adds one Set.has() lookup per event (~O(1)); does NOT block routing
Rollback: git revert <commit>
Hours: 1.0
Owner: Backend
Priority: P2
Docs Updates:
  - docs/Events/Relay/README.md — document unknown event warning behavior
Tests Required:
  - tests/unit/integrations/laravel/event-subscriber.test.ts — "should warn on unknown event names"
```

---

### RL-010 — Metric Label Cardinality Risk

```
Issue ID: RL-010
Severity: INFO
Files Touched:
  - src/integrations/laravel/event-router.ts

Patch Sketch:
```

```diff
--- a/src/integrations/laravel/event-router.ts
+++ b/src/integrations/laravel/event-router.ts
@@ -14,1 +14,2 @@
 import { metrics } from "@src/infrastructure/metrics.js";
+import { KNOWN_EVENT_NAMES } from "./types.js";

@@ -85,3 +86,3 @@
-      metrics.laravelEventsReceived.inc({
-        event_type: event.event,
+      metrics.laravelEventsReceived.inc({
+        event_type: KNOWN_EVENT_NAMES.has(event.event) ? event.event : "unknown",
         delivered: result.delivered ? "true" : "false",
```

```
Downstream Callsites: None (metric label logic only)
Runtime Risk: Minimal — adds one Set.has() per event; unknown events bucketed under "unknown" label
Rollback: git revert <commit>
Hours: 0.5
Owner: Backend
Priority: P2
Docs Updates: None
Tests Required:
  - tests/unit/integrations/laravel/event-router.test.ts — "should bucket unknown events under 'unknown' label"
```

---

## Atomic PR Patch Plan

| PR # | Title | Findings | Files | Depends On |
| ---- | ----- | -------- | ----- | ---------- |
| 1 | `fix(relay): backpressure bug, dead code, Lua hoist` | RL-001, RL-002, RL-003, RL-006, RL-007 | 3 | — |
| 2 | `perf(relay): fix duration metric, add allowlist + cardinality guard` | RL-004, RL-005, RL-009, RL-010 | 3 | — |
| 3 | `test(relay): add unit tests for relay domain` | RL-008 | 3 (new) | PR #1, PR #2 |

### PR Details

**PR #1 — Bug Fixes & Dead Code** (2.25h)
- Fix backpressure check placement (RL-001)
- Remove 3 dead methods (RL-002)
- Hoist Lua to module scope (RL-003)
- Remove dead messageBuffer handler (RL-006)
- Remove optional chaining on metric (RL-007)

**PR #2 — Observability & Safety** (3.0h)
- Move duration metric to EventRouter (RL-004)
- Deprecate KNOWN_EVENTS (RL-005)
- Add unknown event warning (RL-009)
- Guard metric label cardinality (RL-010)

**PR #3 — Test Coverage** (3.0h)
- `event-router.test.ts` — 7 test cases
- `event-subscriber.test.ts` — 7 test cases
- `user-socket.repository.test.ts` — 5 test cases

---

## Sprint Plan

| Sprint | Focus | PRs | Hours |
| ------ | ----- | --- | ----- |
| 1 | All fixes + tests | 1, 2, 3 | 8.25 |

> All findings are small enough to ship in a single sprint.

---

## QA Gates (per PR)

```bash
npm run typecheck   # tsc --noEmit
npm run lint        # eslint src
npm run test        # vitest run
npm run build       # tsup
```

---

## Rollback Procedures

All PRs are atomic and independently revertable:

```bash
# Revert any PR
git revert --no-edit <merge-commit-sha>
npm run build && npm run test
```

No database migrations, no config changes, no API changes — pure code fixes.
