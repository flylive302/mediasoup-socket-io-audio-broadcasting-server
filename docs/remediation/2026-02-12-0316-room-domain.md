# Room Domain Remediation Plan

## Audit Reference

- **Audit:** `docs/audits/2026-02-12-0309-room-domain.md`
- **JSON:** `reports/audit-2026-02-12-0309-room-domain.json`
- **Commit:** `c8804ba` on branch `work`
- **Date:** 2026-02-12

---

## Executive Summary

15 findings across the room domain. Remediation organized into **4 atomic PRs**, totalling **~8.5h**. PRs are ordered by impact: critical business logic & dead alloc fixes first, then performance, then cleanup, then cross-domain activity tracking.

---

## Per-Issue Remediation Details

---

### ROOM-DC-001: Remove Dead `clientsByUserId` Map

````
Issue ID: ROOM-DC-001
Severity: HIGH
Files Touched:
  - src/domains/room/room.handler.ts

Patch Sketch:
```diff
-      const clientsByUserId = new Map<string, (typeof allClients)[0]>();
-
       const participants: {
...
       for (const c of allClients) {
-        clientsByUserId.set(String(c.userId), c);
         if (c.socketId === socket.id) continue;
````

Downstream Callsites:

- None (variable is local and never referenced)

Runtime Risk: Zero — removing pure dead code
Rollback: git revert <commit>
Hours: 0.1
Owner: AI
Priority: P0
Docs Updates: None
Tests Required: None (existing QA gates sufficient)

```

---

### ROOM-BL-002: Fix `room:leave` Missing ClientManager Cleanup

```

Issue ID: ROOM-BL-002
Severity: HIGH
Files Touched:

- src/domains/room/room.handler.ts

Patch Sketch:

```diff
     socket.leave(roomId);
+
+    // Clear room assignment from clientManager (prevent ghost entries in roomClients index)
+    const client = clientManager.getClient(socket.id);
+    if (client?.roomId) {
+      clientManager.setClientRoom(socket.id, '');
+    }

     // BL-001 FIX: Parallelize Redis cleanup and fire-and-forget Laravel
```

> [!IMPORTANT]
> Actually, `setClientRoom` with empty string would add the socket to a `''` room index set. We need a `clearClientRoom` method on ClientManager, OR we can just set roomId to undefined and remove from old room index. The cleanest fix is to add a `clearClientRoom` method.

Revised Patch — `clientManager.ts`:

```diff
+  /**
+   * Clear client's room assignment and update the room index.
+   */
+  clearClientRoom(socketId: string): void {
+    const client = this.clients.get(socketId);
+    if (!client?.roomId) return;
+
+    const roomSet = this.roomClients.get(client.roomId);
+    if (roomSet) {
+      roomSet.delete(socketId);
+      if (roomSet.size === 0) this.roomClients.delete(client.roomId);
+    }
+    client.roomId = undefined;
+  }
```

Room handler:

```diff
     socket.leave(roomId);
+    clientManager.clearClientRoom(socket.id);
```

Downstream Callsites:

- src/socket/index.ts:220 — handleDisconnect (already calls removeClient, unaffected)

Runtime Risk: Low — only clears local Map entry; socket.io leave is already called
Rollback: git revert <commit>
Hours: 0.5
Owner: AI
Priority: P0
Tests Required:

- tests/unit/client/clientManager.test.ts — add test for clearClientRoom

```

---

### ROOM-BL-004: Add `recordActivity` to `room:leave`

```

Issue ID: ROOM-BL-004
Severity: MEDIUM
Files Touched:

- src/domains/room/room.handler.ts

Patch Sketch:

```diff
     const [newCount] = await Promise.all([
       roomManager.state.adjustParticipantCount(roomId, -1),
       userSocketRepository.clearUserRoom(socket.data.user.id),
+      autoCloseService.recordActivity(roomId),
     ]);
```

Downstream Callsites:

- src/domains/room/auto-close/auto-close.service.ts:19 — recordActivity (existing method)

Runtime Risk: Low — adds one Redis SET to existing Promise.all
Rollback: git revert <commit>
Hours: 0.2
Owner: AI
Priority: P1
Tests Required: None (integration-level; covered by QA gates)

```

---

### ROOM-INFO-002: Fix `joinRoomSchema` roomId Validator

```

Issue ID: ROOM-INFO-002
Severity: INFO
Files Touched:

- src/socket/schemas.ts

Patch Sketch:

```diff
 export const joinRoomSchema = z.object({
-  roomId: z.string(),
+  roomId: roomIdSchema,
   ownerId: z.number().optional(),
```

Downstream Callsites:

- src/domains/room/room.handler.ts:21 — room:join handler

Runtime Risk: Theoretically breaks if someone passes empty roomId (shouldn't happen)
Rollback: git revert <commit>
Hours: 0.1
Owner: AI
Priority: P2
Tests Required:

- tests/unit/socket/schemas.test.ts — verify joinRoomSchema rejects empty roomId

```

---

### ROOM-PERF-001: Cache Lua Script with `defineCommand`

```

Issue ID: ROOM-PERF-001
Severity: MEDIUM
Files Touched:

- src/domains/room/roomState.ts

Patch Sketch:

```diff
 export class RoomStateRepository {
   private readonly PREFIX = "room:state:";
   private readonly TTL = 86400; // 24 hours
+  private commandDefined = false;

   constructor(private readonly redis: Redis) {}

+  /**
+   * Register the Lua script once via defineCommand for EVALSHA caching.
+   */
+  private ensureCommand(): void {
+    if (this.commandDefined) return;
+    this.redis.defineCommand("adjustParticipants", {
+      numberOfKeys: 1,
+      lua: `
+        local data = redis.call('GET', KEYS[1])
+        if not data then return nil end
+        local state = cjson.decode(data)
+        state.participantCount = math.max(0, state.participantCount + tonumber(ARGV[1]))
+        state.lastActivityAt = tonumber(ARGV[2])
+        local newState = cjson.encode(state)
+        redis.call('SETEX', KEYS[1], tonumber(ARGV[3]), newState)
+        return state.participantCount
+      `,
+    });
+    this.commandDefined = true;
+  }

   async adjustParticipantCount(
     roomId: string,
     delta: number,
   ): Promise<number | null> {
     const key = `${this.PREFIX}${roomId}`;
-
-    const luaScript = `...`;
-
-    const result = await this.redis.eval(
-      luaScript, 1, key,
-      delta.toString(), Date.now().toString(), this.TTL.toString(),
-    );
+    this.ensureCommand();
+
+    const result = await (this.redis as any).adjustParticipants(
+      key,
+      delta.toString(),
+      Date.now().toString(),
+      this.TTL.toString(),
+    );

     return result as number | null;
   }
```

Downstream Callsites:

- src/domains/room/room.handler.ts:133 — room:join
- src/domains/room/room.handler.ts:205 — room:leave
- src/socket/index.ts:193 — handleDisconnect

Runtime Risk: Low — ioredis defineCommand is well-documented; EVALSHA auto-falls back to EVAL
Rollback: git revert <commit>
Hours: 0.5
Owner: AI
Priority: P1
Tests Required: None (functional behavior unchanged; QA gates cover)

```

---

### ROOM-PERF-002: Make `getRoom()` Synchronous

```

Issue ID: ROOM-PERF-002
Severity: LOW
Files Touched:

- src/domains/room/roomManager.ts
- src/domains/media/media.handler.ts (7 callsites)
- src/socket/index.ts (1 callsite)
- src/domains/seat/handlers/mute-seat.handler.ts (1 callsite)
- src/domains/seat/handlers/unmute-seat.handler.ts (1 callsite)
- src/domains/seat/handlers/lock-seat.handler.ts (1 callsite)

Patch Sketch — roomManager.ts:

```diff
-  async getRoom(roomId: string): Promise<RoomMediaCluster | undefined> {
+  getRoom(roomId: string): RoomMediaCluster | undefined {
     return this.rooms.get(roomId);
   }
```

All 11 callers: remove `await`:

```diff
-    const cluster = await context.roomManager.getRoom(roomId);
+    const cluster = context.roomManager.getRoom(roomId);
```

Downstream Callsites:

- src/domains/media/media.handler.ts:36,66,86,149,189,221,256
- src/socket/index.ts:174
- src/domains/seat/handlers/mute-seat.handler.ts:58
- src/domains/seat/handlers/unmute-seat.handler.ts:58
- src/domains/seat/handlers/lock-seat.handler.ts:50

Runtime Risk: None — Map.get() is synchronous; removing await on non-Promise is a no-op
Rollback: git revert <commit>
Hours: 0.5
Owner: AI
Priority: P2
Tests Required: None (type checker will catch mismatches)

```

---

### ROOM-ARCH-001: Parallelize `closeRoom` Operations

```

Issue ID: ROOM-ARCH-001
Severity: MEDIUM
Files Touched:

- src/domains/room/roomManager.ts

Patch Sketch:

```diff
     // 3. Cleanup Mediasoup + Redis in parallel (independent operations)
-    await cluster.close();
-    this.rooms.delete(roomId);
-
-    // 4. Cleanup Redis
-    await this.stateRepo.delete(roomId);
-
-    // BL-009 FIX: Cleanup seat data
-    if (this.seatRepository) {
-      await this.seatRepository.clearRoom(roomId);
-    }
+    const cleanupOps: Promise<void>[] = [
+      cluster.close(),
+      this.stateRepo.delete(roomId),
+    ];
+    if (this.seatRepository) {
+      cleanupOps.push(this.seatRepository.clearRoom(roomId));
+    }
+    await Promise.all(cleanupOps);
+    this.rooms.delete(roomId);
```

Downstream Callsites:

- src/socket/index.ts:58 — autoCloseJob callback
- src/domains/room/roomManager.ts:136 — handleWorkerDeath

Runtime Risk: Low — all three are independent; Promise.all preserves error semantics
Rollback: git revert <commit>
Hours: 0.3
Owner: AI
Priority: P1
Tests Required: None (functional behavior unchanged)

```

---

### ROOM-DC-002: Remove Dead `speakers` Field

```

Issue ID: ROOM-DC-002
Severity: MEDIUM
Files Touched:

- src/domains/room/types.ts
- src/domains/room/roomManager.ts

Patch Sketch — types.ts:

```diff
 export interface RoomState {
   id: string;
   status: RoomStatus;
   participantCount: number;
   seatCount: number;
   createdAt: number;
   lastActivityAt: number;
-  speakers: string[];
 }
```

roomManager.ts:

```diff
       seatCount: 15,
       createdAt: Date.now(),
       lastActivityAt: Date.now(),
-      speakers: [],
     });
```

Downstream Callsites: None
Runtime Risk: Zero — field never read
Rollback: git revert <commit>
Hours: 0.2
Owner: AI
Priority: P2
Tests Required: None

```

---

### ROOM-DC-003: Remove Dead `Seat` Interface

```

Issue ID: ROOM-DC-003
Severity: MEDIUM
Files Touched:

- src/domains/room/types.ts

Patch Sketch:

```diff
-export interface Seat {
-  index: number;
-  userId: string | null;
-  muted: boolean;
-}
```

Downstream Callsites: None
Runtime Risk: Zero — never imported
Rollback: git revert <commit>
Hours: 0.1
Owner: AI
Priority: P2
Tests Required: None

```

---

### ROOM-DC-004: Simplify `RoomStatus` Type

```

Issue ID: ROOM-DC-004
Severity: MEDIUM
Files Touched:

- src/domains/room/types.ts

Patch Sketch:

```diff
-export type RoomStatus = "CREATED" | "ACTIVE" | "CLOSING" | "CLOSED";
+export type RoomStatus = "ACTIVE";
```

Downstream Callsites:

- src/domains/room/roomManager.ts:94 — only uses "ACTIVE"

Runtime Risk: Zero — only "ACTIVE" is ever assigned
Rollback: git revert <commit>
Hours: 0.2
Owner: AI
Priority: P2
Tests Required: None

```

---

### ROOM-DC-005: Remove Dead `get()` Method

```

Issue ID: ROOM-DC-005
Severity: MEDIUM
Files Touched:

- src/domains/room/roomState.ts

Patch Sketch:

```diff
-  async get(roomId: string): Promise<RoomState | null> {
-    const key = `${this.PREFIX}${roomId}`;
-    const data = await this.redis.get(key);
-    return data ? JSON.parse(data) : null;
-  }
```

Downstream Callsites: None
Runtime Risk: Zero
Rollback: git revert <commit>
Hours: 0.1
Owner: AI
Priority: P2
Tests Required: None

```

---

### ROOM-DC-006: Remove Barrel Export of `RoomStateRepository`

```

Issue ID: ROOM-DC-006
Severity: LOW
Files Touched:

- src/domains/room/index.ts

Patch Sketch:

```diff
-export { RoomStateRepository } from "./roomState.js";
```

Downstream Callsites: None (only imported via relative import in roomManager.ts)
Runtime Risk: Zero
Rollback: git revert <commit>
Hours: 0.1
Owner: AI
Priority: P3
Tests Required: None

```

---

### ROOM-BL-003: Persist `seatCount` to Room State

```

Issue ID: ROOM-BL-003
Severity: MEDIUM
Files Touched:

- src/domains/room/room.handler.ts
- src/domains/room/roomState.ts (optional: add updateSeatCount method)

Patch Sketch — room.handler.ts, after getOrCreateRoom:

```diff
       const cluster = await roomManager.getOrCreateRoom(roomId);
       const rtpCapabilities = cluster.router?.rtpCapabilities;
+
+      // BL-003 FIX: Update seatCount in state if frontend sends a different value
+      if (seatCount !== 15) {
+        const state = await roomManager.state.get(roomId);
+        if (state && state.seatCount !== seatCount) {
+          state.seatCount = seatCount;
+          await roomManager.state.save(state);
+        }
+      }
```

> [!NOTE]
> Since we're removing `get()` in ROOM-DC-005, we should NOT remove it if we use it here. Resolution: keep the `get()` method (revising ROOM-DC-005 to "keep for BL-003 usage") OR inline the update into the Lua script. The simplest approach: keep `get()`, use it here, and remove ROOM-DC-005 from the plan.

**Revised decision:** Keep `RoomStateRepository.get()` — it's needed for BL-003. Mark ROOM-DC-005 as **resolved by usage**.

Downstream Callsites:

- src/domains/room/roomState.ts:10 — save()
- src/domains/room/roomState.ts:15 — get()

Runtime Risk: Low — adds one Redis GET+SET on first join with non-default seatCount
Rollback: git revert <commit>
Hours: 0.5
Owner: AI
Priority: P1
Tests Required: None (functional verification via QA gates)

```

---

### ROOM-BL-001: Add `recordActivity` to Chat, Gift, and Seat Handlers

```

Issue ID: ROOM-BL-001
Severity: HIGH
Files Touched:

- src/domains/chat/chat.handler.ts
- src/domains/gift/giftHandler.ts
- src/domains/seat/handlers/take-seat.handler.ts
- src/domains/seat/handlers/leave-seat.handler.ts

Patch Sketch — chat.handler.ts:

```diff
     socket.nsp.to(payload.roomId).emit("chat:message", message);
+
+    // Record room activity (prevents auto-close during active chat)
+    context.autoCloseService.recordActivity(payload.roomId).catch(() => {});
```

giftHandler.ts (inside gift:send):

```diff
     sock.to(payload.roomId).emit("gift:received", { ... });
+
+    // Record room activity
+    context.autoCloseService.recordActivity(payload.roomId).catch(() => {});
```

take-seat.handler.ts:

```diff
     socket.to(roomId).emit("seat:updated", { ... });
+
+    // Record room activity
+    context.autoCloseService.recordActivity(roomId).catch(() => {});
```

leave-seat.handler.ts (similar pattern)

Downstream Callsites:

- src/domains/room/auto-close/auto-close.service.ts:19 — recordActivity

Runtime Risk: Low — fire-and-forget Redis SET; .catch() ensures no unhandled rejections
Rollback: git revert <commit>
Hours: 1
Owner: AI
Priority: P0
Tests Required: None (integration-level; verified by QA gates)

````

---

## Atomic PR Plan

| PR # | Title                                                 | Issues                                      | Files | Depends On |
| ---- | ----------------------------------------------------- | ------------------------------------------- | ----- | ---------- |
| 1    | fix(room): critical BL fixes + dead alloc removal     | DC-001, BL-002, BL-004, INFO-002            | 3     | —          |
| 2    | perf(room): Lua caching, sync getRoom, parallel close | PERF-001, PERF-002, ARCH-001                | 6     | —          |
| 3    | refactor(room): dead code cleanup + seatCount persist | DC-002, DC-003, DC-004, DC-006, BL-003      | 4     | —          |
| 4    | fix(room): add recordActivity to all domain handlers  | BL-001                                      | 4     | —          |

Each PR must pass:
```bash
npm run lint
npm run typecheck
npm run test
npm run build
````

---

## Sprint Plan

| Sprint | Focus Area                       | PRs | Hours |
| ------ | -------------------------------- | --- | ----- |
| 1      | All (single-session remediation) | 1-4 | 8.5   |

> All PRs are independent and can be applied in a single session.

---

## Infrastructure Recommendations

No infrastructure changes needed for room domain remediation. All fixes are application-level code changes.

---

## Rollback Procedures

All PRs are atomic git commits. Rollback any PR with:

```bash
git revert <commit-sha>
```

No database migrations, Redis schema changes, or external service dependencies in any PR.

---

## Verification Plan

### Automated Tests (run after each PR)

```bash
npm run lint        # ESLint
npm run typecheck   # tsc --noEmit
npm run test        # vitest run
npm run build       # tsup
```

### Existing Tests that Verify Correctness

- `tests/unit/client/clientManager.test.ts` — verifies `clearClientRoom` (after we add the test)
- `tests/unit/socket/schemas.test.ts` — verifies schema validation (INFO-002 fix)

### No Manual Testing Required

All changes are to backend internal logic (in-memory Maps, Redis calls, dead code removal). No UI or external API surface changes.
