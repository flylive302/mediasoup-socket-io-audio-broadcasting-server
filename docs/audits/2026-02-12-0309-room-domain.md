# Room Domain Forensic Audit

## Context Metadata

| Key           | Value                                       |
| ------------- | ------------------------------------------- |
| Branch        | `work`                                      |
| Commit        | `c8804ba`                                   |
| Node          | `v24.12.0`                                  |
| Audit Date    | `2026-02-12T03:09:00+05:00`                 |
| Scope         | `src/domains/room/**` + related infra files |
| Files Audited | 15                                          |

---

## Executive Summary

The room domain is **architecturally sound** with good patterns (race-condition-safe `getOrCreateRoom`, parallelized Redis ops, fire-and-forget Laravel updates). However, the audit uncovered **6 dead code items**, **4 business logic gaps**, **3 performance optimizations**, and **2 architectural concerns**. The most impactful finding is the **`clientsByUserId` map** that is allocated and populated on every join but never read ‚Äî pure wasted CPU/memory. The room domain has **zero test coverage**.

---

## Domain Coverage Matrix

| File                    | Lines | Dead Code | BL Gaps | Perf | Test Coverage |
| ----------------------- | ----- | --------- | ------- | ---- | ------------- |
| `room.handler.ts`       | 225   | 1         | 2       | 1    | ‚ùå None       |
| `roomManager.ts`        | 197   | 0         | 0       | 1    | ‚ùå None       |
| `roomState.ts`          | 60    | 1         | 1       | 1    | ‚ùå None       |
| `types.ts`              | 18    | 3         | 0       | 0    | N/A           |
| `auto-close/service.ts` | 108   | 0         | 1       | 0    | ‚ùå None       |
| `auto-close/job.ts`     | 90    | 0         | 0       | 0    | ‚ùå None       |
| `index.ts` (barrel)     | 17    | 1         | 0       | 0    | N/A           |

---

## Findings by Dimension

### üî¥ CRITICAL & HIGH Findings

---

#### ROOM-DC-001: Dead `clientsByUserId` Map (Built on Every Join, Never Read)

```
Severity: HIGH
File: src/domains/room/room.handler.ts
Function: room:join handler
Problem: clientsByUserId Map is allocated and populated on L47+L67 but never read
Evidence: `const clientsByUserId = new Map<string, ‚Ä¶>()` + `clientsByUserId.set(String(c.userId), c)`
Impact: Wasted allocation + O(N) set operations on every room join ‚Äî pure CPU/memory waste
Fix: Remove L47 and L67 entirely
Complexity: 0.1h
```

---

#### ROOM-BL-001: `recordActivity` Only Called on Join ‚Äî Not on Leave, Chat, Gifts, or Seats

```
Severity: HIGH
File: src/domains/room/room.handler.ts + auto-close/auto-close.service.ts
Function: recordActivity
Problem: Docstring says "Called on: join, leave, seat actions, chat, gifts" but only called on join (L134)
Evidence: grep for recordActivity shows exactly 1 call site (room.handler.ts:134)
Impact: Rooms with sustained activity (chatting, gifts) but no new joins will be falsely marked inactive after ROOM_INACTIVITY_TIMEOUT_MS (30s) and auto-closed
Fix: Call autoCloseService.recordActivity(roomId) in chat.handler, gift.handler, seat handlers, and room:leave
Complexity: 1h
```

---

#### ROOM-BL-002: `room:leave` Handler Missing Client Cleanup

```
Severity: HIGH
File: src/domains/room/room.handler.ts
Function: room:leave handler (L183-223)
Problem: When a user explicitly calls room:leave, the handler does NOT call clientManager.removeClient() or clientManager.setClientRoom() ‚Äî the client remains in the roomClients index
Evidence: Compare room:leave (L183-223) vs handleDisconnect (socket/index.ts:220) ‚Äî disconnect calls removeClient, leave does not
Impact: Stale entries in roomClients index; getClientsInRoom returns ghost clients; participant counts diverge from reality
Fix: After socket.leave(), call clientManager.setClientRoom(socket.id, '') or clear client.roomId from the room index
Complexity: 0.5h
```

---

### üü° MEDIUM Findings

---

#### ROOM-DC-002: Dead `speakers` Field in `RoomState`

```
Severity: MEDIUM
File: src/domains/room/types.ts (L10) + roomManager.ts (L99)
Function: RoomState interface / doCreateRoom
Problem: speakers[] field is initialized to [] and never updated anywhere in the codebase
Evidence: grep for "speakers" in src/domains/room/ shows only declaration (types.ts:10) and initialization (roomManager.ts:99)
Impact: Dead field serialized to Redis on every state save ‚Äî adds ~15 bytes/key + JSON parse overhead
Fix: Remove speakers from RoomState interface and from the save() call in doCreateRoom
Complexity: 0.2h
```

---

#### ROOM-DC-003: Dead `Seat` Interface in `types.ts`

```
Severity: MEDIUM
File: src/domains/room/types.ts (L13-17)
Function: Seat interface
Problem: Seat interface is defined but never imported by any file in the codebase
Evidence: grep for 'import.*from.*room/types' returns 0 results matching Seat; only RoomState is imported
Impact: Dead code cluttering the types file
Fix: Remove Seat interface (seat domain has its own SeatData type in seat.repository.ts)
Complexity: 0.1h
```

---

#### ROOM-DC-004: Dead `RoomStatus` Values (`CREATED`, `CLOSING`, `CLOSED`)

```
Severity: MEDIUM
File: src/domains/room/types.ts (L1)
Function: RoomStatus type
Problem: RoomStatus defines 4 values but only "ACTIVE" is ever used (in roomManager.ts:94)
Evidence: grep for CREATED/CLOSING/CLOSED in src/ shows zero usage beyond the type definition itself
Impact: Misleading type suggests a state machine that doesn't exist ‚Äî maintenance burden for future devs
Fix: Either implement the state machine or reduce to just "ACTIVE" | simplify to a boolean
Complexity: 0.2h
```

---

#### ROOM-DC-005: Dead `RoomStateRepository.get()` Method

```
Severity: MEDIUM
File: src/domains/room/roomState.ts (L15-19)
Function: RoomStateRepository.get
Problem: The get() method is defined but never called anywhere in the codebase
Evidence: grep for 'stateRepo.get' and 'state.get(' returns 0 results
Impact: Dead code; if RoomState is needed it would require deserialization overhead that currently serves no purpose
Fix: Remove the method or mark it @internal for future use
Complexity: 0.1h
```

---

#### ROOM-DC-006: Dead `RoomStateRepository` Export from Barrel

```
Severity: LOW
File: src/domains/room/index.ts (L10)
Function: barrel export
Problem: RoomStateRepository is exported from the barrel but never imported externally ‚Äî it's only used internally by RoomManager
Evidence: grep shows RoomStateRepository imported only in roomManager.ts (via relative import), never via the barrel
Impact: Pollutes the public API surface
Fix: Remove the export from index.ts
Complexity: 0.1h
```

---

#### ROOM-PERF-001: Lua Script Recompiled on Every `adjustParticipantCount` Call

```
Severity: MEDIUM
File: src/domains/room/roomState.ts (L27-57)
Function: adjustParticipantCount
Problem: Lua script string is created inline on every call; ioredis eval() recompiles it each time
Evidence: `const luaScript = \`...\`` inside the method body (L35-46), called via redis.eval()
Impact: Redis must SHA1-hash and parse the Lua script on every participant join/leave ‚Äî avoidable latency
Fix: Use redis.defineCommand() at constructor time or cache the script SHA via SCRIPT LOAD + EVALSHA
Complexity: 0.5h
```

---

#### ROOM-PERF-002: `RoomManager.getRoom()` is Unnecessarily Async

```
Severity: LOW
File: src/domains/room/roomManager.ts (L193-195)
Function: getRoom
Problem: getRoom() is declared async but only does a synchronous Map.get() ‚Äî creates unnecessary Promise overhead
Evidence: `async getRoom(roomId: string): Promise<RoomMediaCluster | undefined> { return this.rooms.get(roomId); }`
Impact: Each call allocates a Promise microtask; called on every media event (transport create, produce, consume)
Fix: Remove async/await, return RoomMediaCluster | undefined directly. Update all callers
Complexity: 0.5h
```

---

#### ROOM-BL-003: `seatCount` from Join Payload Never Persisted to Room State

```
Severity: MEDIUM
File: src/domains/room/room.handler.ts (L26) + roomManager.ts (L96)
Function: room:join handler + doCreateRoom
Problem: seatCount is destructured from the join payload (L26) and passed to seatRepository.getSeats (L109), but never used to update the room state's seatCount field which is hardcoded to 15 (roomManager.ts:96)
Evidence: BL-008 comment says "Default; updated when first joiner sends seatCount" but no update code exists
Impact: Room state in Redis always shows seatCount=15 regardless of actual configuration; auto-close and any future analytics using room state will have wrong data
Fix: After getOrCreateRoom(), check if state.seatCount differs and update via stateRepo.save() or a new Lua script
Complexity: 0.5h
```

---

#### ROOM-BL-004: Missing `recordActivity` on `room:leave`

```
Severity: MEDIUM
File: src/domains/room/room.handler.ts
Function: room:leave handler (L183-223)
Problem: room:leave decrements participant count but does NOT record activity ‚Äî a room with 1 person leaving could be auto-closed immediately if the activity key already expired
Evidence: Compare room:join (L134: autoCloseService.recordActivity) vs room:leave (no call)
Impact: Edge case: last person leaves ‚Üí activity key may already be expired ‚Üí room immediately eligible for auto-close without proper grace period
Fix: Add autoCloseService.recordActivity(roomId) to the room:leave handler's Promise.all
Complexity: 0.2h
```

---

#### ROOM-ARCH-001: `closeRoom` Serializes Mediasoup Close Before Redis Cleanup

```
Severity: MEDIUM
File: src/domains/room/roomManager.ts (L156-191)
Function: closeRoom
Problem: Steps 3 (cluster.close) and 4 (stateRepo.delete + seatRepository.clearRoom) are serialized with awaits, but they are independent operations
Evidence: L181-190: `await cluster.close()` then `await this.stateRepo.delete()` then `await this.seatRepository.clearRoom()`
Impact: Room close takes mediasoup_close_time + redis_delete_time + redis_clear_time instead of max(mediasoup, redis)
Fix: Parallelize: Promise.all([cluster.close(), this.stateRepo.delete(roomId), this.seatRepository?.clearRoom(roomId)])
Complexity: 0.3h
```

---

#### ROOM-ARCH-002: Stale Client Cleanup in Join Handler is Reactive, Not Proactive

```
Severity: LOW
File: src/domains/room/room.handler.ts (L70-80)
Function: room:join handler (stale client check)
Problem: Stale clients are only detected when a new user joins and iterates all clients. If no one joins, stale clients persist in the index indefinitely
Evidence: L71-79: `if (!clientSocket?.connected) { clientManager.removeClient(c.socketId); }`
Impact: In low-join-frequency rooms, phantom participants accumulate in the clientManager room index
Fix: Consider adding a periodic cleanup sweep or leveraging Socket.IO's built-in disconnect events more aggressively
Complexity: 1h
```

---

### üü¢ INFO Findings

---

#### ROOM-INFO-001: Zero Test Coverage for Room Domain

```
Severity: INFO
File: tests/unit/domains/room/* (missing)
Problem: No test files exist for room.handler.ts, roomManager.ts, roomState.ts, or auto-close/*
Evidence: find tests/ -name '*.test.ts' shows 0 results matching room/*
Impact: Regression risk on all room lifecycle changes
Fix: Add unit tests for getOrCreateRoom, adjustParticipantCount, auto-close logic, and join/leave handlers
Complexity: 4h
```

---

#### ROOM-INFO-002: `joinRoomSchema.roomId` Uses Bare `z.string()` Instead of `roomIdSchema`

```
Severity: INFO
File: src/socket/schemas.ts (L161)
Function: joinRoomSchema
Problem: joinRoomSchema uses z.string() for roomId while all other schemas use the reusable roomIdSchema (z.string().min(1))
Evidence: L161 `roomId: z.string()` vs L167 `roomId: roomIdSchema`
Impact: joinRoomSchema accepts empty string roomIds; other schemas don't ‚Äî inconsistency
Fix: Replace z.string() with roomIdSchema in joinRoomSchema
Complexity: 0.1h
```

---

## Over-Engineering Penalties

None found. The room domain is appropriately lean.

---

## Aggregate Scores

| Dimension                  | Weight | Score (0-10) | Weighted   |
| -------------------------- | ------ | ------------ | ---------- |
| Performance & Efficiency   | 30     | 7            | 21         |
| Architecture & Scalability | 20     | 8            | 16         |
| Realtime Correctness       | 15     | 6            | 9          |
| Code Quality               | 15     | 6            | 9          |
| Security & Reliability     | 10     | 8            | 8          |
| Readability                | 10     | 8            | 8          |
| **Total**                  |        |              | **71/100** |

**Deductions:**

- -3 Performance: dead `clientsByUserId` alloc on every join, Lua recompilation, async `getRoom`
- -2 Realtime: `recordActivity` gap means rooms falsely auto-close during active usage
- -2 Code Quality: 6 dead code items, zero test coverage
- -2 Architecture: serialized closeRoom, `room:leave` missing client cleanup

---

## Priority Remediation Queue

| Priority | ID            | Severity | Complexity | Description                                         |
| -------- | ------------- | -------- | ---------- | --------------------------------------------------- |
| 1        | ROOM-BL-001   | HIGH     | 1h         | `recordActivity` missing from leave/chat/gift/seats |
| 2        | ROOM-BL-002   | HIGH     | 0.5h       | `room:leave` missing clientManager cleanup          |
| 3        | ROOM-DC-001   | HIGH     | 0.1h       | Remove dead `clientsByUserId` map                   |
| 4        | ROOM-PERF-001 | MEDIUM   | 0.5h       | Cache Lua script with defineCommand                 |
| 5        | ROOM-BL-003   | MEDIUM   | 0.5h       | Persist `seatCount` to room state                   |
| 6        | ROOM-ARCH-001 | MEDIUM   | 0.3h       | Parallelize `closeRoom` operations                  |
| 7        | ROOM-DC-002   | MEDIUM   | 0.2h       | Remove dead `speakers` field                        |
| 8        | ROOM-DC-003   | MEDIUM   | 0.1h       | Remove dead `Seat` interface                        |
| 9        | ROOM-DC-004   | MEDIUM   | 0.2h       | Reduce or implement `RoomStatus` state machine      |
| 10       | ROOM-DC-005   | MEDIUM   | 0.1h       | Remove dead `get()` method                          |
| 11       | ROOM-BL-004   | MEDIUM   | 0.2h       | Add `recordActivity` to `room:leave`                |
| 12       | ROOM-PERF-002 | LOW      | 0.5h       | Make `getRoom()` synchronous                        |
| 13       | ROOM-DC-006   | LOW      | 0.1h       | Remove barrel export of `RoomStateRepository`       |
| 14       | ROOM-INFO-002 | INFO     | 0.1h       | Fix `joinRoomSchema` roomId validator               |
| 15       | ROOM-INFO-001 | INFO     | 4h         | Add unit tests for room domain                      |

**Total estimated effort: ~8.5h**
