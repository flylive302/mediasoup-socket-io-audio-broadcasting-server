# Relay Domain Forensic Audit

> **Scope**: `src/integrations/laravel/` (Relay domain only)  
> **Date**: 2026-02-13  
> **Branch**: `work` · **Commit**: `28ec11d`  
> **Auditor**: AI Forensic Agent

---

## Executive Summary

The Relay domain (`EventRouter` + `EventSubscriber` + `UserSocketRepository`) is architecturally sound — a simple pass-through that correctly avoids over-engineering. However, the audit uncovered **10 findings**: 1 HIGH (logic bug), 3 MEDIUM (dead code + performance), 3 LOW (hygiene), and 3 INFO (test coverage + observability gaps). Estimated remediation: **6–8 hours**.

---

## Context Metadata

| Key            | Value                              |
| -------------- | ---------------------------------- |
| Branch         | `work`                             |
| Commit         | `28ec11d`                          |
| Files Analyzed | 5 source files, ~830 total lines   |
| Test Coverage  | **0 tests** (zero unit test files) |

### Files in Scope

| File                        | Lines | Purpose                           |
| --------------------------- | ----- | --------------------------------- |
| `event-router.ts`           | 234   | Route events to Socket.IO targets |
| `event-subscriber.ts`       | 185   | Redis pub/sub listener            |
| `user-socket.repository.ts` | 180   | userId → socketId Redis mapping   |
| `types.ts`                  | 122   | Event types and RELAY_EVENTS      |
| `index.ts`                  | 24    | Barrel exports                    |

---

## Findings by Severity

---

### RL-001 — Backpressure Check After Decrement (Logic Bug)

```
Severity: HIGH
File: src/integrations/laravel/event-subscriber.ts
Function: message handler (lines 80–89)
Problem: Backpressure threshold check runs AFTER inFlightCount is decremented
Evidence: `finally { metrics.laravelEventsInFlight.dec(); this.inFlightCount--; if (this.inFlightCount > BACKPRESSURE_THRESHOLD) ... }`
Impact: Backpressure is detected 1 event late and never fires when exactly at threshold+1 because the count has already dropped
Fix: Move the backpressure check BEFORE the decrement, or check at the entry point (after increment)
Complexity: 0.5h
Docs: docs/Events/Relay/README.md
```

**Current code** (event-subscriber.ts:80–89):

```typescript
} finally {
  metrics.laravelEventsInFlight.dec();
  this.inFlightCount--;                    // ← decremented first
  if (this.inFlightCount > BACKPRESSURE_THRESHOLD) {  // ← too late
    this.logger.warn(/* ... */);
  }
}
```

**Fix**: Check immediately after increment:

```diff
 metrics.laravelEventsInFlight.inc();
 this.inFlightCount++;
+if (this.inFlightCount > BACKPRESSURE_THRESHOLD) {
+  this.logger.warn(
+    { inFlight: this.inFlightCount, threshold: BACKPRESSURE_THRESHOLD },
+    "Laravel event subscriber backpressure detected",
+  );
+}
```

---

### RL-002 — 3 Dead Methods in UserSocketRepository

```
Severity: MEDIUM
File: src/integrations/laravel/user-socket.repository.ts
Function: hasActiveSockets(), getSocketCount(), clearUser()
Problem: These methods are defined but never called anywhere in the codebase
Evidence: `rg 'hasActiveSockets|getSocketCount|clearUser[^R]' src/` — only definition hits
Impact: Dead code increases maintenance burden and confuses readers about which methods matter
Fix: Remove all 3 methods (30 lines)
Complexity: 0.5h
Docs: None
```

---

### RL-003 — Inline Lua Script Re-parsed on Every Call

```
Severity: MEDIUM
File: src/integrations/laravel/user-socket.repository.ts
Function: unregisterSocket() (lines 53–60)
Problem: Lua script string is re-created on every unregisterSocket() call
Evidence: `const UNREGISTER_LUA = \`redis.call('srem',...)\``  defined inside the method body
Impact: Minor GC pressure — string is allocated per disconnect. At scale (thousands of disconnects/sec) this adds up
Fix: Hoist UNREGISTER_LUA to module-level const or use redis.defineCommand() for pre-caching
Complexity: 0.5h
Docs: None
```

---

### RL-004 — Processing Duration Measures Sync Parse Only

```
Severity: MEDIUM
File: src/integrations/laravel/event-subscriber.ts
Function: message handler (line 69–73)
Problem: Duration histogram only measures JSON parse + onEvent call (sync), not actual routing time (async)
Evidence: `const durationSec = (Date.now() - startTime) / 1000;` — but onEvent calls route() which is async fire-and-forget
Impact: Metric `flylive_laravel_event_processing_duration_seconds` is misleadingly low — measures ~0.01ms (parse), not actual socket emit latency
Fix: Either measure duration in EventRouter.route() itself, or pass startTime through the callback
Complexity: 1h
Docs: docs/Events/Relay/README.md
```

---

### RL-005 — Dead `KNOWN_EVENTS` and `KnownEventType` Exports

```
Severity: LOW
File: src/integrations/laravel/types.ts
Function: KNOWN_EVENTS, KnownEventType
Problem: Exported but never imported by any consumer in the codebase
Evidence: `rg 'KNOWN_EVENTS|KnownEventType' src/` — only hits in types.ts and index.ts (barrel)
Impact: Misleading API surface — consumers don't know if they should use RELAY_EVENTS or KNOWN_EVENTS
Fix: Deprecate KNOWN_EVENTS with @deprecated JSDoc. Remove after confirming no external consumers.
Complexity: 0.5h
Docs: docs/Events/Relay/README.md
```

---

### RL-006 — Dead `messageBuffer` Handler

```
Severity: LOW
File: src/integrations/laravel/event-subscriber.ts
Function: messageBuffer handler (lines 94–96)
Problem: Logs but does nothing — events arriving as Buffer are silently dropped
Evidence: `this.subscriber.on("messageBuffer", ... => { this.logger.debug("...buffer mode") })`
Impact: If ioredis sends messageBuffer instead of message, events are lost without metric tracking or alerting
Fix: Either parse the Buffer→string and route, or remove the handler and document that Buffer mode is unsupported
Complexity: 0.5h
Docs: docs/Events/Relay/README.md
```

---

### RL-007 — Optional Chaining Inconsistency on Metrics

```
Severity: LOW
File: src/integrations/laravel/event-router.ts
Function: route() (line 85)
Problem: Uses `metrics.laravelEventsReceived?.inc()` with optional chaining while all other metric calls don't
Evidence: `metrics.laravelEventsReceived?.inc({` vs `metrics.laravelEventsInFlight.inc()` (no ?.)
Impact: Inconsistency signals uncertainty — is the metric optional? It's not. All metrics are eagerly initialized.
Fix: Remove the `?.` — use direct `.inc()` like every other metric call
Complexity: 0.25h
Docs: None
```

---

### RL-008 — Zero Unit Test Coverage for Relay Domain

```
Severity: INFO
File: tests/unit/ (missing files)
Function: EventRouter, LaravelEventSubscriber, UserSocketRepository
Problem: No test files exist for any relay domain class
Evidence: `fd 'laravel|relay|event-router|event-subscriber' tests/` — 0 results
Impact: Regression risk for all routing, parsing, and user-socket logic. The backpressure bug (RL-001) would have been caught by tests.
Fix: Create tests for: (a) EventRouter — 4 routing modes, (b) parseEvent — malformed inputs, (c) UserSocketRepository — register/unregister/get
Complexity: 3h
Docs: None
```

---

### RL-009 — No Event Allowlist Validation

```
Severity: INFO
File: src/integrations/laravel/event-subscriber.ts
Function: parseEvent() (lines 139–183)
Problem: Any event name from Redis is accepted and routed — no validation against RELAY_EVENTS
Evidence: Only checks `typeof obj.event !== "string"` — never checks if event name is known
Impact: Typos or rogue events from Laravel are silently relayed to frontend, making debugging harder
Fix: Add optional allowlist mode: log unknown events at warn level (don't block — preserve pass-through)
Complexity: 1h
Docs: docs/Events/Relay/README.md
```

---

### RL-010 — Metric Label Cardinality Risk

```
Severity: INFO
File: src/integrations/laravel/event-router.ts, event-subscriber.ts
Function: metrics recording
Problem: `event_type` label can grow unboundedly if Laravel sends arbitrary event names
Evidence: `metrics.laravelEventsReceived?.inc({ event_type: event.event })` — event.event is unvalidated free-text
Impact: Prometheus cardinality explosion if rogue events arrive — memory growth in prom-client
Fix: Either validate against known events (see RL-009), or bucket unknown events under an "unknown" label
Complexity: 0.5h
Docs: None
```

---

## Over-Engineering Penalties

**None.** The relay domain is appropriately simple:

- `EventRouter` is a clean pass-through with no unnecessary abstraction
- `UserSocketRepository` follows established patterns (Redis Sets)
- No inheritance hierarchies, no unnecessary interfaces, no premature generalisation
- The `RELAY_EVENTS` domain grouping adds zero runtime cost (compile-time only)

---

## Aggregate Scores

| Dimension                  | Weight  | Score (0–10) | Weighted     |
| -------------------------- | ------- | ------------ | ------------ |
| Performance & Efficiency   | 30      | 7.5          | 225          |
| Architecture & Scalability | 20      | 8.0          | 160          |
| Realtime Correctness       | 15      | 7.0          | 105          |
| Code Quality               | 15      | 6.0          | 90           |
| Security & Reliability     | 10      | 7.5          | 75           |
| Readability                | 10      | 8.0          | 80           |
| **Total**                  | **100** |              | **735/1000** |

---

## Priority Remediation Queue

| Priority  | ID     | Severity | Fix                                       | Effort    |
| --------- | ------ | -------- | ----------------------------------------- | --------- |
| 1         | RL-001 | HIGH     | Move backpressure check before decrement  | 0.5h      |
| 2         | RL-008 | INFO     | Create unit tests for 3 classes           | 3.0h      |
| 3         | RL-002 | MEDIUM   | Remove 3 dead methods                     | 0.5h      |
| 4         | RL-003 | MEDIUM   | Hoist Lua script to module scope          | 0.5h      |
| 5         | RL-004 | MEDIUM   | Fix processing duration metric placement  | 1.0h      |
| 6         | RL-006 | LOW      | Remove or implement messageBuffer handler | 0.5h      |
| 7         | RL-009 | INFO     | Add unknown-event warn logging            | 1.0h      |
| 8         | RL-010 | INFO     | Bucket unknown event labels               | 0.5h      |
| 9         | RL-005 | LOW      | Deprecate KNOWN_EVENTS                    | 0.5h      |
| 10        | RL-007 | LOW      | Remove optional chaining on metric        | 0.25h     |
| **Total** |        |          |                                           | **8.25h** |
